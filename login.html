<!DOCTYPE html>
<html lang="es">
<head>
    <title>Selección de Municipio</title>
</head>
<body>

    <div id="loading-container">
        Cargando estado de la sesión...
    </div>

    <div id="contenido-protegido" style="display: none;">
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <p>Bienvenido, <span id="user-email"></span></p>
            <button id="btnLogout">Cerrar Sesión</button>
        </div>
        <hr>
        
        <h2>Selección de Municipio</h2>
        <select id="municipio-selector"></select>
        <button id="btnAccederFormularios" disabled>Acceder a formularios</button>

    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

      // Insertamos la configuración y los datos desde Python (Jinja2)
      const firebaseConfig = {{ firebase_config_data | safe }};
      const municipiosData = {{ municipios_json_data | safe }};
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // Referencias
      const protectedContent = document.getElementById('contenido-protegido');
      const loadingContainer = document.getElementById('loading-container');
      const selector = document.getElementById('municipio-selector');
      const btnAcceder = document.getElementById('btnAccederFormularios');

      // Función para popular el selector (igual que antes)
      function populateSelector() {
          // ... (código para rellenar el selector y añadir listeners) ...
          selector.innerHTML = '<option value="" disabled selected>Seleccione su municipio...</option>'; 
          
          municipiosData.forEach(muni => {
              const option = document.createElement('option');
              option.value = muni.code; 
              option.textContent = muni.name;
              selector.appendChild(option);
          });
          selector.addEventListener('change', () => {
              btnAcceder.disabled = false;
          });
      }

      // **FUNCIÓN CLAVE: COMPROBAR SESIÓN**
      onAuthStateChanged(auth, (user) => {
        loadingContainer.style.display = 'none'; // Ocultar el mensaje de carga

        if (user) {
          // El usuario tiene sesión activa
          document.getElementById('user-email').textContent = user.email;
          protectedContent.style.display = 'block'; // Mostrar selector

          populateSelector();
          
          btnAcceder.addEventListener('click', () => {
            const munCode = selector.value;
            // Redirigir al índice de formularios de ese municipio
            window.location.href = `formularios/forms_redirect_${munCode}.html`; 
          });

        } else {
          // El usuario NO tiene sesión. REDIRIGIR AL LOGIN
          alert("Su sesión ha expirado o no ha iniciado sesión. Será redirigido.");
          window.location.href = 'login.html'; 
        }
      });
      
      // Botón de Logout
      document.getElementById('btnLogout').addEventListener('click', () => {
        signOut(auth).then(() => {
            // Después de cerrar sesión, redirigir inmediatamente al login
            window.location.href = 'login.html';
        });
      });
    </script>
</body>
</html>