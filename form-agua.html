<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Agua - EIEL</title>
<style>
body { font-family: Arial; padding: 16px; background:#f7f7f7; }
.container {
  background: white; padding: 20px; border-radius: 8px;
  max-width: 800px; margin: auto; box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
input, button {
  padding:10px; margin:8px 0; width:100%; max-width:350px;
}
table { width:100%; border-collapse: collapse; margin-top:10px; }
table td, table th {
  border:1px solid #ccc; padding:8px; text-align:center;
}
.file-list { margin-top:8px; }
.file-item { background:#eee; padding:6px; margin:3px 0; border-radius:4px; display:flex; justify-content:space-between; }
button { cursor:pointer; background:#1976d2; color:white; border:none; border-radius:5px; }
button:hover { background:#145a9c; }
#mensaje { font-weight:bold; margin-top:10px; }
</style>
</head>

<body>
<div class="container">

<h2>Formulario — Agua</h2>
<p>Municipio: <span id="muniName"></span></p>

<table>
<thead>
<tr><th>Depósito</th><th>Última limpieza</th></tr>
</thead>
<tbody id="tablaDepositos"></tbody>
</table>

<h3>Adjuntar archivos</h3>
<input type="file" id="fileInput" multiple>
<div id="fileList" class="file-list"></div>

<button id="firmarBtn">Firmar y enviar</button>
<div id="mensaje"></div>
</div>

<script>
// ------------------------
// CONFIG
// ------------------------
const URL_DRIVE = "https://script.google.com/macros/s/AKfycbwlBX0c9UToC0-lU-Pk2FqS-fBCuY_Nq23_NUnb4ekUjLBkOf7itt5edUU3r-TV2FmnpQ/exec";
const URL_GOOGLE_FORMS = "https://docs.google.com/forms/d/e/1FAIpQLSc84PLY4O2wM9ek3v6L14DzZ8jcqDtFeKOK01i38s7ttPt0Ng/formResponse"; // 

let municipio = localStorage.getItem("usuarioActual") || "";
document.getElementById("muniName").textContent = municipio;

// ------------------------
// DEPOSITOS — DE EJEMPLO
// (luego los cargarás desde PostgreSQL)
// ------------------------
let depositos = [
  { nombre:"Depósito Alto", fecha:"" },
  { nombre:"Depósito Centro", fecha:"" },
  { nombre:"Depósito Sur", fecha:"" }
];

// Pintar tabla
function pintarTabla(){
  let html = "";
  depositos.forEach((d,i)=>{
    html += `<tr>
      <td>${d.nombre}</td>
      <td><input type="date" onchange="cambiarFecha(${i},this.value)" value="${d.fecha}"></td>
    </tr>`;
  });
  document.getElementById("tablaDepositos").innerHTML = html;
}
pintarTabla();

function cambiarFecha(i, val){
  depositos[i].fecha = val;
}

// ------------------------
// ARCHIVOS
// ------------------------
let archivos = [];
const input = document.getElementById("fileInput");
const fileList = document.getElementById("fileList");

input.onchange = ()=>{
  archivos = Array.from(input.files);
  renderArchivos();
};

function eliminarArchivo(i){
  archivos.splice(i,1);
  renderArchivos();
}

function renderArchivos(){
  fileList.innerHTML = archivos.map((f,i)=>`
    <div class="file-item">
      ${f.name}
      <button style="width:30px;background:#b71c1c" onclick="eliminarArchivo(${i})">X</button>
    </div>
  `).join("");
}

// ------------------------
// ENVIAR
// ------------------------
document.getElementById("firmarBtn").addEventListener("click", async()=>{

  console.log("Archivos antes de enviar:", archivos); // ✅ añade esto
  document.getElementById("mensaje").textContent = "Procesando...";

  // ✅ 1. Subir archivos a Drive vía Apps Script
  if(archivos.length>0){
    const fd = new FormData();
    archivos.forEach((f,i)=>fd.append("file"+i,f));
    fd.append("municipio", municipio);

    try{
    await fetch(URL_DRIVE, { 
      method: "POST",
      body: fd,
      mode: "no-cors"
    });
    }catch(err){
      document.getElementById("mensaje").textContent = "❌ Error subiendo archivos a Drive";
      console.error(err);
      return;
    }
  }

  // ✅ 2. Enviar datos a Google Forms
  const formData = new FormData();
  formData.append("entry.960913048", municipio);
  formData.append("entry.312379068", JSON.stringify(depositos));
  formData.append("entry.1907656835", archivos.map(a=>a.name).join(", "));

  try{
    await fetch(URL_GOOGLE_FORMS, { method:"POST", body: formData, mode:"no-cors" });
  }catch(err){
    document.getElementById("mensaje").textContent = "❌ Error enviando datos a Google Forms";
    console.error(err);
    return;
  }

  // ✅ 3. Confirmación
  document.getElementById("mensaje").textContent = "✅ Datos enviados correctamente";

  // ✅ 4. Descargar PDF local (si ya tienes esta función)
  if(typeof generarPDFResumen === "function"){ generarPDFResumen(); }
});
</script>

</body>
</html>
