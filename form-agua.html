<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Agua</title>
<style>
body { font-family: Arial; margin: 20px; }
input, button { display: block; margin: 10px 0; padding: 8px; width: 100%; max-width: 400px; }
ul { list-style: none; padding: 0; }
li { margin: 5px 0; }
.borrar { color: red; cursor: pointer; margin-left: 10px; font-weight: bold; }
</style>
</head>
<body>

<h2>Formulario Agua</h2>
<p>Municipio: <span id="municipio"></span></p>

<input type="file" id="archivoInput" multiple>
<ul id="archivosAdjuntos"></ul>

<button id="firmarBtn">Firmar y enviar</button>
<button onclick="cerrarSesion()">Cerrar sesión</button>

<p id="mensaje" style="color:green;"></p>

<!-- Librería jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Sesión
const usuario = localStorage.getItem("usuarioActual");
if (!usuario) {
  window.location.href = "login.html";
} else {
  document.getElementById("municipio").textContent = usuario;
}

// Array temporal para archivos
let archivos = [];

// Adjuntar archivos automáticamente al seleccionar
document.getElementById("archivoInput").addEventListener("change", function(e) {
  for (const file of e.target.files) {
    archivos.push(file);
  }
  mostrarArchivos();
  e.target.value = "";
});

// Mostrar lista de archivos con botón de borrar
function mostrarArchivos() {
  const lista = document.getElementById("archivosAdjuntos");
  lista.innerHTML = "";
  archivos.forEach((f, i) => {
    const li = document.createElement("li");
    li.textContent = f.name;
    const btn = document.createElement("span");
    btn.textContent = "✖";
    btn.className = "borrar";
    btn.onclick = () => {
      archivos.splice(i, 1);
      mostrarArchivos();
    };
    li.appendChild(btn);
    lista.appendChild(li);
  });
}

// Firmar y enviar
document.getElementById("firmarBtn").addEventListener("click", async function() {
  if (archivos.length === 0) {
    alert("No hay archivos adjuntos");
    return;
  }

  const formData = new FormData();
  formData.append("usuario", usuario);
  archivos.forEach((f,i) => formData.append(`archivo${i}`, f));

  try {
    const res = await fetch("https://formspree.io/f/movporjk", { // <--- reemplaza XXXX por tu endpoint
      method: "POST",
      body: formData
    });

    if (!res.ok) throw new Error("Error en el envío");

    document.getElementById("mensaje").textContent = "Formulario firmado y enviado correctamente";

    // Generar resguardo PDF
    generarResguardoPDF();

    // Limpiar archivos
    archivos = [];
    mostrarArchivos();
  } catch (err) {
    console.error(err);
    alert("No se pudo enviar el formulario");
  }
});

// Generar resguardo en PDF
function generarResguardoPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const fecha = new Date().toLocaleString();

  doc.setFontSize(16);
  doc.text("Resguardo Formulario EIEL", 10, 10);
  doc.setFontSize(12);
  doc.text(`Fecha: ${fecha}`, 10, 20);
  doc.text(`Municipio: ${usuario}`, 10, 30);

  let y = 40;
  doc.text("Archivos adjuntos:", 10, y);
  y += 10;
  archivos.forEach(f => {
    doc.text(f.name, 15, y);
    y += 10;
  });

  doc.save(`resguardo_${usuario}_${Date.now()}.pdf`);
}

function cerrarSesion() {
  localStorage.removeItem("usuarioActual");
  window.location.href = "login.html";
}
</script>

</body>
</html>
