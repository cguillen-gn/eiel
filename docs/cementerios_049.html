<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cementerios - Municipio Municipio 049</title>
    
    <link rel="stylesheet" href="css/style.css">
    
    <script>
        window.EIEL_CONFIG = {
            muniCode: "049",
            muniName: "Municipio 049",
            urlAdjuntos: "https://script.google.com/macros/s/AKfycbySvcn7wgRbbNhnoKYPND7Ij7CaPgLzFKbNq-AfX80CkyV1J7aIKUQ8tQGYmmKBNQjb8A/exec",
            urlGenerarPdf: "https://script.google.com/macros/s/AKfycbyxhsTZynldpFj9kyUIYmtflvHKvKr_ew4mRaB8LlnqEh5gxAC5f1ORRjIY2unS5ioO/exec",
            urlGoogleForms: "https://docs.google.com/forms/d/e/1FAIpQLSc84PLY4O2wM9ek3v6L14DzZ8jcqDtFeKOK01i38s7ttPt0Ng/formResponse"
        };
    </script>
</head>
<body>

    <div class="container">
        
        <nav style="margin-bottom: 20px;">
            <a href="../index.html" class="btn btn-secondary" style="background:none; color: var(--primary); padding-left:0;">
                ‚Üê Volver al men√∫ principal
            </a>
        </nav>

        <header class="header">
            <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem;">
                ‚ö∞Ô∏è 
                Cementerios Municipales
            </h1>
            <div style="opacity: 0.9;">
                Municipio: <strong>Municipio 049</strong> (049)
            </div>
        </header>

        <main>
            





<div class="card" style="background-color: #fffbeb; border-left: 4px solid var(--warning);">
    <p style="font-size: 0.9rem; color: #92400e;">
        <strong>OCUPACI√ìN:</strong> Para la correcta valoraci√≥n del nivel de saturaci√≥n, indique el n√∫mero de unidades ocupadas.<br>
        El total se calcula sumando: Ocupadas + Concesi√≥n + Propiedad + Libres.
    </p>
</div>



<div class="card">
    <h2 class="section-title">üìç CEMENTERIO</h2>
    
    <div class="cementerio-table-wrapper">
        <table class="cementerio-table">
            <thead>
                <tr>
                    <th class="header-ocupacion" colspan="2">OCUPACI√ìN</th>
                    <th>FOSAS</th>
                    <th>NICHOS</th>
                    <th>COLUMBARIOS</th>
                    <th>OSARIOS</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label-cell">OCUPADAS</td>
                    <td class="sublabel-cell"></td> 
                    <td><input type="number" min="0" data-cem="1" data-tipo="ocupadas_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="ocupadas_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="ocupadas_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="ocupadas_osarios" placeholder="0"></td>
                </tr>

                <tr>
                    <td class="label-cell" rowspan="3">LIBRES</td> 
                    <td class="sublabel-cell">EN CONCESI√ìN</td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_concesion_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_concesion_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_concesion_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_concesion_osarios" placeholder="0"></td>
                </tr>

                <tr>
                    <td class="sublabel-cell">PROPIEDAD PRIVADA</td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_propiedad_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_propiedad_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_propiedad_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_propiedad_osarios" placeholder="0"></td>
                </tr>

                <tr>
                    <td class="sublabel-cell">
                        PROPIEDAD MUNICIPAL<br>
                        <span style="font-size: 0.75rem;">(DISPONIBLES)</span>
                    </td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_municipal_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_municipal_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_municipal_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="1" data-tipo="libres_municipal_osarios" placeholder="0"></td>
                </tr>

                <tr class="total-row">
                    <td class="label-cell" colspan="2">TOTAL</td> 
                    <td id="total_fosas_1">0</td>
                    <td id="total_nichos_1">0</td>
                    <td id="total_columbarios_1">0</td>
                    <td id="total_osarios_1">0</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>



<div class="card">
    <h2 class="section-title">Documentaci√≥n Adjunta (Opcional)</h2>
    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" style="border: 2px dashed var(--border); padding: 2rem; text-align: center; cursor: pointer; border-radius: 8px;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìé</div>
        <div style="color: var(--primary); font-weight: 600;">Haga clic para adjuntar archivos</div>
        <input type="file" id="fileInput" multiple style="display: none;">
    </div>
    <div id="fileList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;"></div>
</div>


<div class="card">
    <button id="firmarBtn" class="btn btn-primary">
        <span>‚úì</span> Firmar y enviar formulario
    </button>
    <div id="mensaje" class="message"></div>
</div>



        </main>

        <div class="card" style="margin-top: 2rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
            EIEL 2025 - Diputaci√≥n de Alicante
        </div>

    </div>

    <script src="js/upload.js"></script>
    
    
<script>
    // Inyectamos datos del servidor
    const cementerios = [{"nombre": "CEMENTERIO"}];
    
    // ==========================================
    // 1. L√ìGICA DE C√ÅLCULO (Igual que antes)
    // ==========================================
    function calcularTotales() {
        cementerios.forEach((cem, index) => {
            const cemIndex = index + 1;
            const inputs = document.querySelectorAll(`input[data-cem="${cemIndex}"]`);
            
            let totales = { fosas: 0, nichos: 0, columbarios: 0, osarios: 0 };
            
            inputs.forEach(input => {
                const tipo = input.dataset.tipo;
                const valor = parseInt(input.value) || 0;
                
                if (tipo.includes('fosas')) totales.fosas += valor;
                if (tipo.includes('nichos')) totales.nichos += valor;
                if (tipo.includes('columbarios')) totales.columbarios += valor;
                if (tipo.includes('osarios')) totales.osarios += valor;
            });
            
            // Actualizar DOM de forma segura
            const setTotal = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.textContent = val;
            };

            setTotal(`total_fosas_${cemIndex}`, totales.fosas);
            setTotal(`total_nichos_${cemIndex}`, totales.nichos);
            setTotal(`total_columbarios_${cemIndex}`, totales.columbarios);
            setTotal(`total_osarios_${cemIndex}`, totales.osarios);
        });
    }

    document.addEventListener('input', (e) => {
        if (e.target.type === 'number' && e.target.dataset.cem) {
            calcularTotales();
        }
    });

    // ==========================================
    // 2. GESTI√ìN DE ARCHIVOS (UI Local)
    // ==========================================
    let archivos = [];
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");

    if (fileInput) {
        fileInput.onchange = () => {
            archivos.push(...Array.from(fileInput.files));
            renderArchivos();
            fileInput.value = '';
        };
    }

    window.eliminarArchivo = (i) => {
        archivos.splice(i, 1);
        renderArchivos();
    }

    function renderArchivos() {
        if (archivos.length === 0) {
            fileList.innerHTML = '';
            return;
        }
        fileList.innerHTML = archivos.map((f, i) => `
            <div style="display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--border);">
                <span>üìÑ ${f.name}</span>
                <button type="button" onclick="eliminarArchivo(${i})" class="btn-danger">‚úñ</button>
            </div>
        `).join("");
    }

    // ==========================================
    // 3. ENV√çO (Usa UploadService y window.EIEL_CONFIG)
    // ==========================================
    const btnFirmar = document.getElementById("firmarBtn");
    const mensajeDiv = document.getElementById("mensaje");

    function mostrarMensaje(texto, tipo) {
        mensajeDiv.textContent = texto;
        mensajeDiv.className = `message ${tipo}`;
        mensajeDiv.style.display = 'block';
    }

    if (btnFirmar) {
        btnFirmar.addEventListener("click", async () => {
            btnFirmar.disabled = true;
            mostrarMensaje("‚è≥ Subiendo archivos...", "info");

            // A) Subir Archivos a Drive
            let erroresSubida = 0;
            for (const file of archivos) {
                // LLAMADA AL NUEVO SERVICIO CENTRALIZADO
                const ok = await UploadService.uploadFile(
                    file, 
                    'cementerios', 
                    window.EIEL_CONFIG.muniCode
                );
                if (!ok) erroresSubida++;
            }

            if (erroresSubida > 0) {
                mostrarMensaje(`‚ö†Ô∏è Se subieron archivos con ${erroresSubida} errores. Continuando...`, "warning");
            }

            // B) Recopilar Datos
            mostrarMensaje("‚è≥ Generando justificante...", "info");
            
            const datosCementerios = cementerios.map((cem, index) => {
                const cemIndex = index + 1;
                const inputs = document.querySelectorAll(`input[data-cem="${cemIndex}"]`);
                let datos = { nombre: cem.nombre };
                
                inputs.forEach(input => {
                    const tipo = input.dataset.tipo;
                    const val = parseInt(input.value);
                    datos[tipo] = isNaN(val) ? 0 : val;
                });
                return datos;
            });

            const userEmail = localStorage.getItem("userEmailActual");
            const payload = {
                tipo_formulario: "cementerios",
                cementerios_data: JSON.stringify(datosCementerios),
                email_usuario: userEmail,
                municipio_codigo: window.EIEL_CONFIG.muniCode,
                municipio_nombre: window.EIEL_CONFIG.muniName,
                timestamp_envio: new Date().toISOString(),
                archivos_adjuntos: archivos.map(a => a.name).join("\n")
            };

            // C) Enviar a Generar PDF
            try {
                const response = await fetch(window.EIEL_CONFIG.urlGenerarPdf, {
                    method: "POST",
                    body: new URLSearchParams(payload)
                });

                let result = {};
                try {
                    result = await response.json();
                } catch(e) {
                    // Si el servidor devuelve 200 pero el navegador bloquea el JSON por CORS
                    if(response.ok) {
                        result = { success: true, message: "Env√≠o correcto (CORS opaco)." };
                    } else {
                        throw new Error("Error de respuesta del servidor.");
                    }
                }

                if (result.success || response.ok) {
                    mostrarMensaje("‚úÖ Formulario enviado correctamente. Revisa tu email.", "success");
                    archivos = [];
                    renderArchivos();
                    if(result.downloadUrl) window.open(result.downloadUrl, '_blank');
                } else {
                    throw new Error(result.message || "Error desconocido");
                }
            } catch (error) {
                console.error(error);
                mostrarMensaje(`‚ùå Error: ${error.message}`, "error");
                btnFirmar.disabled = false;
            }
        });
    }
</script>

    
    <script>
        // L√≥gica de seguridad simple que ya ten√≠as, ahora centralizada
        const userEmail = localStorage.getItem("userEmailActual");
        const codigoMuniLogueado = localStorage.getItem("municipioCodigoActual");
        const formMunicipioCodigo = window.EIEL_CONFIG.muniCode;

        if (!userEmail || !codigoMuniLogueado) {
            window.location.href = "../login.html";
        } else if (codigoMuniLogueado !== formMunicipioCodigo) {
            alert(`No tienes permiso para el municipio ${formMunicipioCodigo}.`);
            window.location.href = "../login.html";
        }
    </script>
</body>
</html>