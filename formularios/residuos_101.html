<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Residuos - 101</title>
<style>
/* ------------------------------------------- /
/ ESTILOS BASE Y GENERALES /
/ ------------------------------------------- /
body { font-family: 'Inter', Arial, sans-serif; padding: 16px; background:#e8f5e9; }
.container {
background: white; padding: 25px; border-radius: 12px;
max-width: 1100px;
margin: 20px auto;
box-shadow:0 6px 20px rgba(0,0,0,0.15);
border-top: 5px solid #3F51B5; / Color de acento azul */
}
input, button, select {
padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc;
box-sizing: border-box;
transition: border-color 0.3s, box-shadow 0.3s;
}
input:focus, select:focus {
border-color: #3F51B5;
box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
outline: none;
}

button {
cursor:pointer; background:#3F51B5; color:white; border:none;
transition: background 0.3s; font-weight: bold;
padding: 12px 20px;
}
button:hover { background:#303F9F; }

/* ------------------------------------------- /
/ ESTILOS DE LA TABLA HTML EST√ÅNDAR /
/ ------------------------------------------- /
.residuos-table {
width:100%;
border-collapse: collapse;
font-size: 14px;
table-layout: fixed; / Asegura que los anchos de columna se mantengan */
margin-top: 20px;
border: 1px solid #c0c0c0;
}

.residuos-table th {
background: #3F51B5; /* Fondo de cabecera azul */
color: white;
padding: 12px 8px;
text-align: center;
font-weight: 600;
border-right: 1px solid #303F9F;
}

.residuos-table th:last-child {
border-right: none;
}

.residuos-table td {
padding: 6px;
border: 1px solid #e0e0e0;
vertical-align: middle;
height: 60px; /* Altura m√≠nima para centrar los inputs */
}

/* Columna 'Tipo de residuo' - Fila de encabezado */
.residuos-table td:first-child {
background-color: #f7f7f7;
font-weight: 500;
padding-left: 10px;
text-align: left;
}

/* Estilo para los inputs y selects dentro de las celdas */
.residuos-table input[type="number"],
.residuos-table input[type="text"],
.residuos-table select {
width: 100%;
max-width: 100%;
margin: 0;
padding: 6px 4px;
border-radius: 3px;
border: 1px solid #c0c0c0;
background-color: white;
text-align: center;
font-size: 13px;
display: block;
}

/* ------------------------------------------- /
/ OTROS ESTILOS /
/ ------------------------------------------- */
.file-list { margin-top:8px; }
.file-item {
background:#f0f4f7;
padding:6px 10px;
margin:3px 0;
border-radius:4px;
display:flex;
justify-content:space-between;
align-items: center;
}
#mensaje { font-weight:bold; margin-top:15px; text-align: center; }

</style>
</head>

<body>
<div class="container">

<h2>Formulario ‚Äî Residuos</h2>
<p>Municipio: <span id="muniName">101</span></p>

<!-- APARTADO 1: RECOGIDA DE RESIDUOS -->

<h3>Recogida de residuos en el a√±o 2024</h3>

<!-- TABLA COMPLETA CON HTML EST√ÅNDAR Y CAMPOS HARDCODEADOS -->

<table class="residuos-table">
<thead>
<tr>
<th style="width: 25%;">Tipo de residuo</th>
<th style="width: 15%;">Producci√≥n (t/a√±o)</th>
<th style="width: 15%;">N¬∫ contenedores</th>
<th style="width: 20%;">Periodicidad de recogida</th>
<th style="width: 25%; border-right: none;">Vertedero o planta de tratamiento de destino</th>
</tr>
</thead>
<tbody>
<!-- Fila 1: Pl√°sticos y Envases (amarillo) -->
<tr>
<td>Pl√°sticos y Envases (amarillo)</td>
<td>
<input type="number" id="prod_plastico" placeholder="t/a√±o" min="0" step="any">
</td>
<td>
<input type="number" id="cont_plastico" placeholder="N¬∫" min="0">
</td>
<td>
<select id="period_plastico">
<option value="diaria">diaria</option>
<option value="semanal">semanal</option>
<option value="quincenal">quincenal</option>
<option value="dias alternos">dias alternos</option>
<option value="otros">otros</option>
<option value="sin periodicidad">sin periodicidad</option>
</select>
</td>
<td>
<input type="text" id="dest_plastico" placeholder="Vertedero/Planta">
</td>
</tr>

    <!-- Fila 2: Papel y Cart√≥n (azul) -->
    <tr>
        <td>Papel y Cart√≥n (azul)</td>
        <td>
            <input type="number" id="prod_papel" placeholder="t/a√±o" min="0" step="any">
        </td>
        <td>
            <input type="number" id="cont_papel" placeholder="N¬∫" min="0">
        </td>
        <td>
            <select id="period_papel">
                <option value="diaria">diaria</option>
                <option value="semanal">semanal</option>
                <option value="quincenal">quincenal</option>
                <option value="dias alternos">dias alternos</option>
                <option value="otros">otros</option>
                <option value="sin periodicidad">sin periodicidad</option>
            </select>
        </td>
        <td>
            <input type="text" id="dest_papel" placeholder="Vertedero/Planta">
        </td>
    </tr>
    
    <!-- Fila 3: Vidrio (verde) -->
    <tr>
        <td>Vidrio (verde)</td>
        <td>
            <input type="number" id="prod_vidrio" placeholder="t/a√±o" min="0" step="any">
        </td>
        <td>
            <input type="number" id="cont_vidrio" placeholder="N¬∫" min="0">
        </td>
        <td>
            <select id="period_vidrio">
                <option value="diaria">diaria</option>
                <option value="semanal">semanal</option>
                <option value="quincenal">quincenal</option>
                <option value="dias alternos">dias alternos</option>
                <option value="otros">otros</option>
                <option value="sin periodicidad">sin periodicidad</option>
            </select>
        </td>
        <td>
            <input type="text" id="dest_vidrio" placeholder="Vertedero/Planta">
        </td>
    </tr>
    
    <!-- Fila 4: Org√°nico (marr√≥n) -->
    <tr>
        <td>Org√°nico (marr√≥n)</td>
        <td>
            <input type="number" id="prod_organico" placeholder="t/a√±o" min="0" step="any">
        </td>
        <td>
            <input type="number" id="cont_organico" placeholder="N¬∫" min="0">
        </td>
        <td>
            <select id="period_organico">
                <option value="diaria">diaria</option>
                <option value="semanal">semanal</option>
                <option value="quincenal">quincenal</option>
                <option value="dias alternos">dias alternos</option>
                <option value="otros">otros</option>
                <option value="sin periodicidad">sin periodicidad</option>
            </select>
        </td>
        <td>
            <input type="text" id="dest_organico" placeholder="Vertedero/Planta">
        </td>
    </tr>
    
    <!-- Fila 5: No selectiva/resto -->
    <tr>
        <td>No selectiva/resto</td>
        <td>
            <input type="number" id="prod_resto" placeholder="t/a√±o" min="0" step="any">
        </td>
        <td>
            <input type="number" id="cont_resto" placeholder="N¬∫" min="0">
        </td>
        <td>
            <select id="period_resto">
                <option value="diaria">diaria</option>
                <option value="semanal">semanal</option>
                <option value="quincenal">quincenal</option>
                <option value="dias alternos">dias alternos</option>
                <option value="otros">otros</option>
                <option value="sin periodicidad">sin periodicidad</option>
            </select>
        </td>
        <td>
            <input type="text" id="dest_resto" placeholder="Vertedero/Planta">
        </td>
    </tr>
</tbody>


</table>

<!-- APARTADO 2: LIMPIEZA VIARIA -->

<h3 style="margin-top: 30px;">Limpieza Viaria</h3>
<label for="personasLimpieza" style="display:block; font-weight:bold; margin-bottom:5px;">
N√∫mero de personas dedicadas a la limpieza viaria:
</label>
<input
type="number"
id="personasLimpieza"
placeholder="Ej: 5"
min="0"
style="max-width: 250px;"
>

<!-- APARTADO 3: ADJUNTAR ARCHIVOS -->

<h3 style="margin-top: 30px;">Adjuntar Archivos (Opcional)</h3>
<button type="button" onclick="iniciarSubida()">
Adjuntar Archivos
</button>
<div id="adjuntos_residuos" style="font-size:13px; margin-top:4px;"></div>
<div id="fileList" class="file-list"></div>

<button id="firmarBtn" style="margin-top: 25px;">Firmar y enviar</button>

<div id="mensaje"></div>
</div>

<script>
// ------------------------

const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbyaYoePvbzj5ZntRPB8ZFO8AHOmJtUNtDiwiD9Au7BSniFZE5pFHeyGMd0VaLSy-VFknQ/exec";
const URL_GOOGLE_FORMS = "https://docs.google.com/forms/d/e/1FAIpQLSc84PLY4O2wM9ek3v6L14DzZ8jcqDtFeKOK01i38s7ttPt0Ng/formResponse";

// MUNICIPIO inyectado por el generador (c√≥digo INE)
let municipio = "101";
let municipioNombre = "101";

// Estructura de mapeo para recoger los datos de los inputs hardcodeados
const RESIDUO_FIELDS = [
{ type: "Pl√°sticos y Envases (amarillo)", prod: "prod_plastico", cont: "cont_plastico", period: "period_plastico", dest: "dest_plastico" },
{ type: "Papel y Cart√≥n (azul)", prod: "prod_papel", cont: "cont_papel", period: "period_papel", dest: "dest_papel" },
{ type: "Vidrio (verde)", prod: "prod_vidrio", cont: "cont_vidrio", period: "period_vidrio", dest: "dest_vidrio" },
{ type: "Org√°nico (marr√≥n)", prod: "prod_organico", cont: "cont_organico", period: "period_organico", dest: "dest_organico" },
{ type: "No selectiva/resto", prod: "prod_resto", cont: "cont_resto", period: "period_resto", dest: "dest_resto" },
];

// ----------------------------------------------------------------------
// L√ìGICA DE SUBIDA DE ARCHIVOS
// ----------------------------------------------------------------------

let archivos = [];
const fileList = document.getElementById("fileList");

function getBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = () => {
let encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
if ((encoded.length % 4) > 0) {
encoded += '='.repeat(4 - (encoded.length % 4));
}
resolve(encoded);
};
reader.onerror = error => reject(error);
});
}

async function iniciarSubida() {
const fileInput = document.createElement("input");
fileInput.type = "file";
fileInput.multiple = true;
fileInput.style.display = "none";
document.body.appendChild(fileInput);

fileInput.onchange = async () =&gt; {
    const files = Array.from(fileInput.files);
    
    if (!files.length) {
        document.body.removeChild(fileInput);
        return;
    }

    archivos.push(...files);
    renderArchivos();

    const statusDiv = document.getElementById(&quot;adjuntos_residuos&quot;);
    let msgBox = document.createElement(&quot;div&quot;);
    msgBox.style.fontSize = &quot;12px&quot;;
    msgBox.style.fontWeight = &quot;bold&quot;;
    msgBox.style.marginTop = &quot;5px&quot;;
    statusDiv.innerHTML = &#39;&#39;; 
    statusDiv.appendChild(msgBox);

    for (let i = 0; i &lt; files.length; i++) {
        const file = files[i];
        msgBox.textContent = `‚è≥ Subiendo ${i+1}/${files.length}: ${file.name}...`;
        msgBox.style.color = &quot;#f57c00&quot;; // Naranja

        try {
            const base64 = await getBase64(file);

            // IMPORTANTE: tipo: &quot;residuos&quot; para la carpeta Drive [municipio]/residuos
            const payload = {
                tipo: &quot;residuos&quot;,
                mun: municipio,     
                filename: file.name,
                mimeType: file.type,
                file: base64
            };
            
            const resp = await fetch(URL_APPS_SCRIPT, {
                method: &quot;POST&quot;,
                body: JSON.stringify(payload)
            });
            
            const data = await resp.json().catch(() =&gt; ({ status: &quot;unknown&quot; }));

            if (data.status === &quot;error&quot;) throw new Error(data.message);
            
            console.log(`‚úÖ ${file.name} subido.`);

        } catch (err) {
            console.error(err);
            msgBox.textContent = `‚ö†Ô∏è Error subiendo ${file.name}`;
            msgBox.style.color = &quot;red&quot;;
            await new Promise(r =&gt; setTimeout(r, 1000));
        }
    }

    msgBox.textContent = &quot;‚úÖ Archivos procesados&quot;;
    msgBox.style.color = &quot;green&quot;;
    setTimeout(() =&gt; msgBox.remove(), 3000);

    document.body.removeChild(fileInput);
};

fileInput.click();


}

function renderArchivos() {
fileList.innerHTML = archivos
.map((f, i) => &lt;div class=&quot;file-item&quot;&gt; &lt;span&gt;üìé ${f.name}&lt;/span&gt; &lt;button  type=&quot;button&quot;  onclick=&quot;eliminarArchivo(${i})&quot;  style=&quot;border:none; background:none; color:red; cursor:pointer; font-weight:bold; padding:0 5px;&quot; &gt; ‚úñ &lt;/button&gt; &lt;/div&gt;)
.join("");
}

function eliminarArchivo(i) {
archivos.splice(i, 1);
renderArchivos();
}

// ------------------------
// L√ìGICA DE ENV√çO (ADAPTADA AL NUEVO DISE√ëO)
// ------------------------
document.getElementById("firmarBtn").addEventListener("click", async () => {
try {
if (archivos.length === 0) {
document.getElementById("mensaje").textContent = "‚ö†Ô∏è No hay archivos adjuntos (opcional)";
}

    document.getElementById(&quot;mensaje&quot;).textContent = &quot;‚è≥ Enviando datos...&quot;;
    document.getElementById(&quot;firmarBtn&quot;).disabled = true;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#BDBDBD&quot;; 

    // 1. CAPTURAR DATOS DE LA TABLA HARDCODEADA
    const personasLimpieza = document.getElementById(&quot;personasLimpieza&quot;).value;

    const residuosDataCollected = RESIDUO_FIELDS.map(r =&gt; {
        const prodValue = document.getElementById(r.prod).value;
        const contValue = document.getElementById(r.cont).value;

        return {
            tipo: r.type,
            // parseFloat para permitir decimales en producci√≥n
            produccion: prodValue !== &#39;&#39; ? parseFloat(prodValue) : null,
            // parseInt para asegurar que contenedores es entero
            contenedores: contValue !== &#39;&#39; ? parseInt(contValue, 10) : null,
            periodicidad: document.getElementById(r.period).value,
            destino: document.getElementById(r.dest).value,
        };
    });


    // 2. PREPARAR FORM DATA
    const formData = new FormData();
    formData.append(&quot;entry.960913048&quot;, municipioNombre); // Municipio Nombre
    
    // **NOTA: REEMPLAZAR entry.RESIDUOS_FIELD_ID_AQUI con la ID de la tabla de residuos
    formData.append(&quot;entry.RESIDUOS_FIELD_ID_AQUI&quot;, JSON.stringify(residuosDataCollected));
    
    // **NOTA: REEMPLAZAR entry.LIMPIEZA_FIELD_ID_AQUI con la ID del campo de Limpieza Viaria
    formData.append(&quot;entry.LIMPIEZA_FIELD_ID_AQUI&quot;, personasLimpieza); 

    // **NOTA: REEMPLAZAR entry.ARCHIVOS_RESIDUOS_FIELD_ID_AQUI con la ID de la lista de archivos
    formData.append(&quot;entry.ARCHIVOS_RESIDUOS_FIELD_ID_AQUI&quot;, archivos.map(a=&gt;a.name).join(&quot;\n&quot;));

    // 3. ENVIAR
    await fetch(URL_GOOGLE_FORMS, { method:&quot;POST&quot;, body: formData, mode:&quot;no-cors&quot; });

    document.getElementById(&quot;mensaje&quot;).textContent = &quot;‚úÖ Datos enviados correctamente&quot;;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#303F9F&quot;;
    
    // Limpiar
    archivos = [];
    renderArchivos();
    document.getElementById(&quot;personasLimpieza&quot;).value = &#39;&#39;;
    
    // Limpiar campos de la tabla
    RESIDUO_FIELDS.forEach(r =&gt; {
        document.getElementById(r.prod).value = &#39;&#39;;
        document.getElementById(r.cont).value = &#39;&#39;;
        document.getElementById(r.dest).value = &#39;&#39;;
        // Resetear el select a la primera opci√≥n si es necesario
        document.getElementById(r.period).selectedIndex = 0; 
    });
    
} catch(error) {
    document.getElementById(&quot;mensaje&quot;).textContent = &quot;‚ùå Error: &quot; + error.message;
    document.getElementById(&quot;firmarBtn&quot;).disabled = false;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#3F51B5&quot;;
}


});

// --- Control de acceso ---
municipioLogin = localStorage.getItem("usuarioActual");

if (!municipioLogin) {
¬† window.location.href = "login.html";
}

document.addEventListener("DOMContentLoaded", () => {
¬† const muniName = document.getElementById("muniName");
¬† if (muniName) {¬†
¬† ¬† muniName.textContent = localStorage.getItem("usuarioNombre") || municipioLogin;¬† }

¬† const formMunicipio = "101";
¬† if (municipioLogin !== formMunicipio) {
¬† ¬† // Usamos console.error en lugar de alert()
console.error("No tienes permiso para este municipio. Redirigiendo a login.");
¬† ¬† window.location.href = "login.html";
¬† }
});

</script>

</body>
</html>