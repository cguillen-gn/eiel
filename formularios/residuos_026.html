<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Residuos - 026</title>
<style>
/* ------------------------------------------- /
/ ESTILOS BASE Y GENERALES /
/ ------------------------------------------- /
body { font-family: 'Inter', Arial, sans-serif; padding: 16px; background:#e8f5e9; }
.container {
background: white; padding: 25px; border-radius: 12px;
max-width: 1000px;
margin: 20px auto;
box-shadow:0 6px 20px rgba(0,0,0,0.15);
border-top: 5px solid #3F51B5; / Color de acento azul */
}
input, button, select {
padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc;
box-sizing: border-box;
transition: border-color 0.3s, box-shadow 0.3s;
}
input:focus, select:focus {
border-color: #3F51B5;
box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
outline: none;
}

button {
cursor:pointer; background:#3F51B5; color:white; border:none;
transition: background 0.3s; font-weight: bold;
padding: 12px 20px;
}
button:hover { background:#303F9F; }

/* ------------------------------------------- /
/ ESTILOS DE LA TABLA (OPTIMIZADOS PARA CLARIDAD) /
/ ------------------------------------------- /
table {
width:100%;
border-collapse: collapse;
margin-top:20px;
font-size: 14px;
table-layout: fixed;
}
table th {
background: #3F51B5; / Fondo de cabecera azul /
color: white;
padding: 12px 8px;
text-align: center;
border-bottom: 3px solid #303F9F;
font-weight: 600;
}
table td {
border:1px solid #e0e0e0;
padding: 6px;
vertical-align: middle;
}
/ La primera columna que contiene el nombre del residuo /
table td:first-child {
background-color: #f7f7f7; / Fondo gris claro */
text-align: left;
font-weight: 500;
padding-left: 10px;
}

/* ESTILO CR√çTICO: Asegura que los campos de formulario sean visibles y grandes /
table input[type="number"], table input[type="text"], table select {
width: 98%;
max-width: none;
margin: 0; / Sin margen para ocupar el espacio /
padding: 8px 4px; / Relleno generoso /
border-radius: 3px;
border: 1px solid #999; / Borde visible /
background-color: white; / Fondo blanco claro /
text-align: center;
font-size: 14px;
display: block;
}
/ ------------------------------------------- /
/ OTROS ESTILOS /
/ ------------------------------------------- */
.file-list { margin-top:8px; }
.file-item {
background:#f0f4f7;
padding:6px 10px;
margin:3px 0;
border-radius:4px;
display:flex;
justify-content:space-between;
align-items: center;
}
#mensaje { font-weight:bold; margin-top:15px; text-align: center; }

/* Estilos de responsividad simple */
@media (max-width: 600px) {
.container {
padding: 15px;
margin: 0;
border-radius: 0;
}
table {
display: block;
overflow-x: auto;
white-space: nowrap;
}
}
</style>

</head>

<body>
<div class="container">

<h2>Formulario ‚Äî Residuos</h2>
<p>Municipio: <span id="muniName">026</span></p>

<!-- APARTADO 1: RECOGIDA DE RESIDUOS -->

<h3>Recogida de residuos en el a√±o 2024</h3>

<table id="tablaResiduos">
<thead>
<tr>
<th style="width: 25%;">Tipo de residuo</th>
<th style="width: 15%;">Producci√≥n (t/a√±o)</th>
<th style="width: 15%;">N¬∫ contenedores</th>
<th style="width: 20%;">Periodicidad de recogida</th>
<th style="width: 25%;">Vertedero o planta de tratamiento de destino</th>
</tr>
</thead>
<tbody>
<!-- Las 5 filas de residuos se pintar√°n con JavaScript -->
</tbody>
</table>

<!-- APARTADO 2: LIMPIEZA VIARIA -->

<h3 style="margin-top: 30px;">Limpieza Viaria</h3>
<label for="personasLimpieza" style="display:block; font-weight:bold; margin-bottom:5px;">
N√∫mero de personas dedicadas a la limpieza viaria:
</label>
<input
type="number"
id="personasLimpieza"
placeholder="Ej: 5"
min="0"
style="max-width: 250px;"
>

<!-- APARTADO 3: ADJUNTAR ARCHIVOS -->

<h3 style="margin-top: 30px;">Adjuntar Archivos (Opcional)</h3>
<button type="button" onclick="iniciarSubida()">
Adjuntar Archivos
</button>
<div id="adjuntos_residuos" style="font-size:13px; margin-top:4px;"></div>
<div id="fileList" class="file-list"></div>

<button id="firmarBtn" style="margin-top: 25px;">Firmar y enviar</button>

<div id="mensaje"></div>
</div>

<script>
// ------------------------

const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbyaYoePvbzj5ZntRPB8ZFO8AHOmJtUNtDiwiD9Au7BSniFZE5pFHeyGMd0VaLSy-VFknQ/exec";
const URL_GOOGLE_FORMS = "https://docs.google.com/forms/d/e/1FAIpQLSc84PLY4O2wM9ek3v6L14DzZ8jcqDtFeKOK01i38s7ttPt0Ng/formResponse";

// MUNICIPIO inyectado por el generador (c√≥digo INE)
let municipio = "026";
let municipioNombre = "026";

// ------------------------
// DATOS INICIALES Y L√ìGICA DE TABLA
// ------------------------

// Las 5 filas fijas de tipos de residuos
let residuosData = [
{ tipo: "Pl√°sticos y Envases (amarillo)", produccion: null, contenedores: null, periodicidad: "diaria", destino: "" },
{ tipo: "Papel y Cart√≥n (azul)", produccion: null, contenedores: null, periodicidad: "diaria", destino: "" },
{ tipo: "Vidrio (verde)", produccion: null, contenedores: null, periodicidad: "diaria", destino: "" },
{ tipo: "Org√°nico (marr√≥n)", produccion: null, contenedores: null, periodicidad: "diaria", destino: "" },
{ tipo: "No selectiva/resto", produccion: null, contenedores: null, periodicidad: "diaria", destino: "" },
];

const opcionesPeriodicidad = ["diaria", "semanal", "quincenal", "dias alternos", "otros", "sin periodicidad"];

function pintarTabla(){
let html = "";
residuosData.forEach((r, i) => {
// Generar opciones de Periodicidad
const selectOptions = opcionesPeriodicidad.map(opt =>
&lt;option value=&quot;${opt}&quot; ${r.periodicidad === opt ? &#39;selected&#39; : &#39;&#39;}&gt;${opt}&lt;/option&gt;
).join('');

html += `
  &lt;tr&gt;
    &lt;td&gt;${r.tipo}&lt;/td&gt;
    &lt;td&gt;
      &lt;input 
        type=&quot;number&quot; 
        placeholder=&quot;t/a√±o&quot;
        onchange=&quot;actualizarDato(${i}, &#39;produccion&#39;, this.value)&quot; 
        value=&quot;${r.produccion || &#39;&#39;}&quot;
        min=&quot;0&quot;
      &gt;
    &lt;/td&gt;
    &lt;td&gt;
      &lt;input 
        type=&quot;number&quot; 
        placeholder=&quot;N¬∫&quot;
        onchange=&quot;actualizarDato(${i}, &#39;contenedores&#39;, this.value)&quot; 
        value=&quot;${r.contenedores || &#39;&#39;}&quot;
        min=&quot;0&quot;
      &gt;
    &lt;/td&gt;
    &lt;td&gt;
      &lt;select onchange=&quot;actualizarDato(${i}, &#39;periodicidad&#39;, this.value)&quot;&gt;
        ${selectOptions}
      &lt;/select&gt;
    &lt;/td&gt;
    &lt;td&gt;
      &lt;input 
        type=&quot;text&quot; 
        placeholder=&quot;Vertedero/Planta&quot;
        onchange=&quot;actualizarDato(${i}, &#39;destino&#39;, this.value)&quot; 
        value=&quot;${r.destino || &#39;&#39;}&quot;
      &gt;
    &lt;/td&gt;
  &lt;/tr&gt;
`;


});
document.getElementById("tablaResiduos").querySelector("tbody").innerHTML = html;
}

function actualizarDato(i, campo, valor){
// Convertir a n√∫mero si es un campo num√©rico
if (campo === 'produccion' || campo === 'contenedores') {
residuosData[i][campo] = valor !== '' ? parseFloat(valor) : null;
} else {
residuosData[i][campo] = valor;
}
}

pintarTabla();

// ----------------------------------------------------------------------
// L√ìGICA DE SUBIDA DE ARCHIVOS
// ----------------------------------------------------------------------

let archivos = [];
const fileList = document.getElementById("fileList");

function getBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = () => {
let encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
if ((encoded.length % 4) > 0) {
encoded += '='.repeat(4 - (encoded.length % 4));
}
resolve(encoded);
};
reader.onerror = error => reject(error);
});
}

async function iniciarSubida() {
const fileInput = document.createElement("input");
fileInput.type = "file";
fileInput.multiple = true;
fileInput.style.display = "none";
document.body.appendChild(fileInput);

fileInput.onchange = async () =&gt; {
    const files = Array.from(fileInput.files);
    
    if (!files.length) {
        document.body.removeChild(fileInput);
        return;
    }

    archivos.push(...files);
    renderArchivos();

    const statusDiv = document.getElementById(&quot;adjuntos_residuos&quot;);
    let msgBox = document.createElement(&quot;div&quot;);
    msgBox.style.fontSize = &quot;12px&quot;;
    msgBox.style.fontWeight = &quot;bold&quot;;
    msgBox.style.marginTop = &quot;5px&quot;;
    statusDiv.innerHTML = &#39;&#39;; 
    statusDiv.appendChild(msgBox);

    for (let i = 0; i &lt; files.length; i++) {
        const file = files[i];
        msgBox.textContent = `‚è≥ Subiendo ${i+1}/${files.length}: ${file.name}...`;
        msgBox.style.color = &quot;#f57c00&quot;; // Naranja

        try {
            const base64 = await getBase64(file);

            // IMPORTANTE: tipo: &quot;residuos&quot; para la carpeta Drive [municipio]/residuos
            const payload = {
                tipo: &quot;residuos&quot;,
                mun: municipio,     
                filename: file.name,
                mimeType: file.type,
                file: base64
            };
            
            const resp = await fetch(URL_APPS_SCRIPT, {
                method: &quot;POST&quot;,
                body: JSON.stringify(payload)
            });
            
            const data = await resp.json().catch(() =&gt; ({ status: &quot;unknown&quot; }));

            if (data.status === &quot;error&quot;) throw new Error(data.message);
            
            console.log(`‚úÖ ${file.name} subido.`);

        } catch (err) {
            console.error(err);
            msgBox.textContent = `‚ö†Ô∏è Error subiendo ${file.name}`;
            msgBox.style.color = &quot;red&quot;;
            await new Promise(r =&gt; setTimeout(r, 1000));
        }
    }

    msgBox.textContent = &quot;‚úÖ Archivos procesados&quot;;
    msgBox.style.color = &quot;green&quot;;
    setTimeout(() =&gt; msgBox.remove(), 3000);

    document.body.removeChild(fileInput);
};

fileInput.click();


}

function renderArchivos() {
fileList.innerHTML = archivos
.map((f, i) => &lt;div class=&quot;file-item&quot;&gt; &lt;span&gt;üìé ${f.name}&lt;/span&gt; &lt;button  type=&quot;button&quot;  onclick=&quot;eliminarArchivo(${i})&quot;  style=&quot;border:none; background:none; color:red; cursor:pointer; font-weight:bold; padding:0 5px;&quot; &gt; ‚úñ &lt;/button&gt; &lt;/div&gt;)
.join("");
}

function eliminarArchivo(i) {
archivos.splice(i, 1);
renderArchivos();
}

// ------------------------
// L√ìGICA DE ENV√çO
// ------------------------
document.getElementById("firmarBtn").addEventListener("click", async () => {
try {
if (archivos.length === 0) {
document.getElementById("mensaje").textContent = "‚ö†Ô∏è No hay archivos adjuntos (opcional)";
}

    document.getElementById(&quot;mensaje&quot;).textContent = &quot;‚è≥ Enviando datos...&quot;;
    document.getElementById(&quot;firmarBtn&quot;).disabled = true;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#BDBDBD&quot;; 

    // 1. CAPTURAR DATOS
    const personasLimpieza = document.getElementById(&quot;personasLimpieza&quot;).value;

    // 2. PREPARAR FORM DATA
    const formData = new FormData();
    formData.append(&quot;entry.960913048&quot;, municipioNombre); // Municipio Nombre
    
    // **NOTA: REEMPLAZAR entry.RESIDUOS_FIELD_ID_AQUI con la ID de la tabla de residuos
    formData.append(&quot;entry.RESIDUOS_FIELD_ID_AQUI&quot;, JSON.stringify(residuosData));
    
    // **NOTA: REEMPLAZAR entry.LIMPIEZA_FIELD_ID_AQUI con la ID del campo de Limpieza Viaria
    formData.append(&quot;entry.LIMPIEZA_FIELD_ID_AQUI&quot;, personasLimpieza); 

    // **NOTA: REEMPLAZAR entry.ARCHIVOS_RESIDUOS_FIELD_ID_AQUI con la ID de la lista de archivos
    formData.append(&quot;entry.ARCHIVOS_RESIDUOS_FIELD_ID_AQUI&quot;, archivos.map(a=&gt;a.name).join(&quot;\n&quot;));

    // 3. ENVIAR
    await fetch(URL_GOOGLE_FORMS, { method:&quot;POST&quot;, body: formData, mode:&quot;no-cors&quot; });

    document.getElementById(&quot;mensaje&quot;).textContent = &quot;‚úÖ Datos enviados correctamente&quot;;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#303F9F&quot;;
    
    // Limpiar
    archivos = [];
    renderArchivos();
    document.getElementById(&quot;personasLimpieza&quot;).value = &#39;&#39;;
    pintarTabla(); // Resetear la tabla
    
} catch(error) {
    document.getElementById(&quot;mensaje&quot;).textContent = &quot;‚ùå Error: &quot; + error.message;
    document.getElementById(&quot;firmarBtn&quot;).disabled = false;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#3F51B5&quot;;
}


});

// --- Control de acceso ---
municipioLogin = localStorage.getItem("usuarioActual");

if (!municipioLogin) {
¬† window.location.href = "login.html";
}

document.addEventListener("DOMContentLoaded", () => {
¬† const muniName = document.getElementById("muniName");
¬† if (muniName) {¬†
¬† ¬† muniName.textContent = localStorage.getItem("usuarioNombre") || municipioLogin;¬† }

¬† const formMunicipio = "026";
¬† if (municipioLogin !== formMunicipio) {
¬† ¬† // Usamos console.error en lugar de alert()
console.error("No tienes permiso para este municipio. Redirigiendo a login.");
¬† ¬† window.location.href = "login.html";
¬† }
});

</script>

</body>
</html>