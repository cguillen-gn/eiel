<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Residuos - 122</title>
<style>
/* ------------------------------------------- /
/ ESTILOS BASE Y GENERALES /
/ ------------------------------------------- /
body { font-family: 'Inter', Arial, sans-serif; padding: 16px; background:#e8f5e9; }
.container {
background: white; padding: 25px; border-radius: 12px;
max-width: 1000px;
margin: 20px auto;
box-shadow:0 6px 20px rgba(0,0,0,0.15);
border-top: 5px solid #3F51B5; / Color de acento azul */
}
input, button, select {
padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc;
box-sizing: border-box;
transition: border-color 0.3s, box-shadow 0.3s;
}
input:focus, select:focus {
border-color: #3F51B5;
box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
outline: none;
}

button {
cursor:pointer; background:#3F51B5; color:white; border:none;
transition: background 0.3s; font-weight: bold;
padding: 12px 20px;
}
button:hover { background:#303F9F; }

/* ------------------------------------------- /
/ ESTILOS DE LA TABLA (IMPLEMENTACIÃ“N CON CSS GRID) /
/ ------------------------------------------- /
table {
width:100%;
border-collapse: collapse;
font-size: 14px;
table-layout: fixed;
}
table th {
background: #3F51B5; / Fondo de cabecera azul */
color: white;
padding: 12px 8px;
text-align: center;
border-bottom: 3px solid #303F9F;
font-weight: 600;
}

/* Contenedor Grid que simula el cuerpo de la tabla /
.grid-table {
display: grid;
/ Define 5 columnas con los anchos del header /
grid-template-columns: 25% 15% 15% 20% 25%;
border: 1px solid #e0e0e0;
border-top: none; / Se une con el header */
}

/* Cada fila /
.grid-row {
display: contents; / Hace que los hijos (divs) se comporten como celdas de la cuadrÃ­cula padre */
}

/* Cada celda /
.grid-table > div {
border-bottom: 1px solid #e0e0e0;
padding: 6px;
vertical-align: middle;
/ Estilo flex para centrar contenido verticalmente /
display: flex;
align-items: center;
box-sizing: border-box;
}
.grid-table > div:nth-child(5n+1) { / La primera celda de cada fila */
background-color: #f7f7f7;
text-align: left;
font-weight: 500;
padding-left: 10px;
}

/* Estilo para los inputs dentro de las celdas Grid */
.grid-table input[type="number"], .grid-table input[type="text"], .grid-table select {
width: 100%;
max-width: none;
margin: 0;
padding: 8px 4px;
border-radius: 3px;
border: 1px solid #999;
background-color: white;
text-align: center;
font-size: 14px;
display: block;
}

/* ------------------------------------------- /
/ OTROS ESTILOS /
/ ------------------------------------------- */
.file-list { margin-top:8px; }
.file-item {
background:#f0f4f7;
padding:6px 10px;
margin:3px 0;
border-radius:4px;
display:flex;
justify-content:space-between;
align-items: center;
}
#mensaje { font-weight:bold; margin-top:15px; text-align: center; }

/* Estilos de responsividad simple /
@media (max-width: 600px) {
.container {
padding: 15px;
margin: 0;
border-radius: 0;
}
.grid-table {
/ Desactiva la cuadrÃ­cula en pantallas muy pequeÃ±as, mostrando como lista */
grid-template-columns: 1fr;
border-right: none;
}
.grid-table > div {
border-right: none;
border-left: none;
}
}
</style>

</head>

<body>
<div class="container">

<h2>Formulario â€” Residuos</h2>
<p>Municipio: <span id="muniName">122</span></p>

<!-- APARTADO 1: RECOGIDA DE RESIDUOS -->

<h3>Recogida de residuos en el aÃ±o 2024</h3>

<!-- TABLA: SOLO CABECERA REAL -->

<table id="tablaResiduosHeader" style="margin-bottom: 0;">
<thead>
<tr>
<th style="width: 25%;">Tipo de residuo</th>
<th style="width: 15%;">ProducciÃ³n (t/aÃ±o)</th>
<th style="width: 15%;">NÂº contenedores</th>
<th style="width: 20%;">Periodicidad de recogida</th>
<th style="width: 25%;">Vertedero o planta de tratamiento de destino</th>
</tr>
</thead>
</table>

<!-- CUERPO DE LA TABLA: HARDCODEADO CON GRID/DIVS -->

<div id="tablaResiduosContent" class="grid-table">
<!-- Fila 1: PlÃ¡sticos y Envases (amarillo) -->
<div class="grid-row">
<div>PlÃ¡sticos y Envases (amarillo)</div>
<div>
<input type="number" id="prod_plastico" placeholder="t/aÃ±o" min="0" step="any">
</div>
<div>
<input type="number" id="cont_plastico" placeholder="NÂº" min="0">
</div>
<div>
<select id="period_plastico">
<option value="diaria">diaria</option>
<option value="semanal">semanal</option>
<option value="quincenal">quincenal</option>
<option value="dias alternos">dias alternos</option>
<option value="otros">otros</option>
<option value="sin periodicidad">sin periodicidad</option>
</select>
</div>
<div>
<input type="text" id="dest_plastico" placeholder="Vertedero/Planta">
</div>
</div>

<!-- Fila 2: Papel y CartÃ³n (azul) -->
<div class="grid-row">
    <div>Papel y CartÃ³n (azul)</div>
    <div>
        <input type="number" id="prod_papel" placeholder="t/aÃ±o" min="0" step="any">
    </div>
    <div>
        <input type="number" id="cont_papel" placeholder="NÂº" min="0">
    </div>
    <div>
        <select id="period_papel">
            <option value="diaria">diaria</option>
            <option value="semanal">semanal</option>
            <option value="quincenal">quincenal</option>
            <option value="dias alternos">dias alternos</option>
            <option value="otros">otros</option>
            <option value="sin periodicidad">sin periodicidad</option>
        </select>
    </div>
    <div>
        <input type="text" id="dest_papel" placeholder="Vertedero/Planta">
    </div>
</div>

<!-- Fila 3: Vidrio (verde) -->
<div class="grid-row">
    <div>Vidrio (verde)</div>
    <div>
        <input type="number" id="prod_vidrio" placeholder="t/aÃ±o" min="0" step="any">
    </div>
    <div>
        <input type="number" id="cont_vidrio" placeholder="NÂº" min="0">
    </div>
    <div>
        <select id="period_vidrio">
            <option value="diaria">diaria</option>
            <option value="semanal">semanal</option>
            <option value="quincenal">quincenal</option>
            <option value="dias alternos">dias alternos</option>
            <option value="otros">otros</option>
            <option value="sin periodicidad">sin periodicidad</option>
        </select>
    </div>
    <div>
        <input type="text" id="dest_vidrio" placeholder="Vertedero/Planta">
    </div>
</div>

<!-- Fila 4: OrgÃ¡nico (marrÃ³n) -->
<div class="grid-row">
    <div>OrgÃ¡nico (marrÃ³n)</div>
    <div>
        <input type="number" id="prod_organico" placeholder="t/aÃ±o" min="0" step="any">
    </div>
    <div>
        <input type="number" id="cont_organico" placeholder="NÂº" min="0">
    </div>
    <div>
        <select id="period_organico">
            <option value="diaria">diaria</option>
            <option value="semanal">semanal</option>
            <option value="quincenal">quincenal</option>
            <option value="dias alternos">dias alternos</option>
            <option value="otros">otros</option>
            <option value="sin periodicidad">sin periodicidad</option>
        </select>
    </div>
    <div>
        <input type="text" id="dest_organico" placeholder="Vertedero/Planta">
    </div>
</div>

<!-- Fila 5: No selectiva/resto -->
<div class="grid-row">
    <div>No selectiva/resto</div>
    <div>
        <input type="number" id="prod_resto" placeholder="t/aÃ±o" min="0" step="any">
    </div>
    <div>
        <input type="number" id="cont_resto" placeholder="NÂº" min="0">
    </div>
    <div>
        <select id="period_resto">
            <option value="diaria">diaria</option>
            <option value="semanal">semanal</option>
            <option value="quincenal">quincenal</option>
            <option value="dias alternos">dias alternos</option>
            <option value="otros">otros</option>
            <option value="sin periodicidad">sin periodicidad</option>
        </select>
    </div>
    <div>
        <input type="text" id="dest_resto" placeholder="Vertedero/Planta">
    </div>
</div>


</div>

<!-- APARTADO 2: LIMPIEZA VIARIA -->

<h3 style="margin-top: 30px;">Limpieza Viaria</h3>
<label for="personasLimpieza" style="display:block; font-weight:bold; margin-bottom:5px;">
NÃºmero de personas dedicadas a la limpieza viaria:
</label>
<input
type="number"
id="personasLimpieza"
placeholder="Ej: 5"
min="0"
style="max-width: 250px;"
>

<!-- APARTADO 3: ADJUNTAR ARCHIVOS -->

<h3 style="margin-top: 30px;">Adjuntar Archivos (Opcional)</h3>
<button type="button" onclick="iniciarSubida()">
Adjuntar Archivos
</button>
<div id="adjuntos_residuos" style="font-size:13px; margin-top:4px;"></div>
<div id="fileList" class="file-list"></div>

<button id="firmarBtn" style="margin-top: 25px;">Firmar y enviar</button>

<div id="mensaje"></div>
</div>

<script>
// ------------------------

const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbyaYoePvbzj5ZntRPB8ZFO8AHOmJtUNtDiwiD9Au7BSniFZE5pFHeyGMd0VaLSy-VFknQ/exec";
const URL_GOOGLE_FORMS = "https://docs.google.com/forms/d/e/1FAIpQLSc84PLY4O2wM9ek3v6L14DzZ8jcqDtFeKOK01i38s7ttPt0Ng/formResponse";

// MUNICIPIO inyectado por el generador (cÃ³digo INE)
let municipio = "122";
let municipioNombre = "122";

// Estructura de mapeo para recoger los datos de los inputs hardcodeados
const RESIDUO_FIELDS = [
{ type: "PlÃ¡sticos y Envases (amarillo)", prod: "prod_plastico", cont: "cont_plastico", period: "period_plastico", dest: "dest_plastico" },
{ type: "Papel y CartÃ³n (azul)", prod: "prod_papel", cont: "cont_papel", period: "period_papel", dest: "dest_papel" },
{ type: "Vidrio (verde)", prod: "prod_vidrio", cont: "cont_vidrio", period: "period_vidrio", dest: "dest_vidrio" },
{ type: "OrgÃ¡nico (marrÃ³n)", prod: "prod_organico", cont: "cont_organico", period: "period_organico", dest: "dest_organico" },
{ type: "No selectiva/resto", prod: "prod_resto", cont: "cont_resto", period: "period_resto", dest: "dest_resto" },
];

// ----------------------------------------------------------------------
// LÃ“GICA DE SUBIDA DE ARCHIVOS
// ----------------------------------------------------------------------

let archivos = [];
const fileList = document.getElementById("fileList");

function getBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = () => {
let encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
if ((encoded.length % 4) > 0) {
encoded += '='.repeat(4 - (encoded.length % 4));
}
resolve(encoded);
};
reader.onerror = error => reject(error);
});
}

async function iniciarSubida() {
const fileInput = document.createElement("input");
fileInput.type = "file";
fileInput.multiple = true;
fileInput.style.display = "none";
document.body.appendChild(fileInput);

fileInput.onchange = async () =&gt; {
    const files = Array.from(fileInput.files);
    
    if (!files.length) {
        document.body.removeChild(fileInput);
        return;
    }

    archivos.push(...files);
    renderArchivos();

    const statusDiv = document.getElementById(&quot;adjuntos_residuos&quot;);
    let msgBox = document.createElement(&quot;div&quot;);
    msgBox.style.fontSize = &quot;12px&quot;;
    msgBox.style.fontWeight = &quot;bold&quot;;
    msgBox.style.marginTop = &quot;5px&quot;;
    statusDiv.innerHTML = &#39;&#39;; 
    statusDiv.appendChild(msgBox);

    for (let i = 0; i &lt; files.length; i++) {
        const file = files[i];
        msgBox.textContent = `â³ Subiendo ${i+1}/${files.length}: ${file.name}...`;
        msgBox.style.color = &quot;#f57c00&quot;; // Naranja

        try {
            const base64 = await getBase64(file);

            // IMPORTANTE: tipo: &quot;residuos&quot; para la carpeta Drive [municipio]/residuos
            const payload = {
                tipo: &quot;residuos&quot;,
                mun: municipio,     
                filename: file.name,
                mimeType: file.type,
                file: base64
            };
            
            const resp = await fetch(URL_APPS_SCRIPT, {
                method: &quot;POST&quot;,
                body: JSON.stringify(payload)
            });
            
            const data = await resp.json().catch(() =&gt; ({ status: &quot;unknown&quot; }));

            if (data.status === &quot;error&quot;) throw new Error(data.message);
            
            console.log(`âœ… ${file.name} subido.`);

        } catch (err) {
            console.error(err);
            msgBox.textContent = `âš ï¸ Error subiendo ${file.name}`;
            msgBox.style.color = &quot;red&quot;;
            await new Promise(r =&gt; setTimeout(r, 1000));
        }
    }

    msgBox.textContent = &quot;âœ… Archivos procesados&quot;;
    msgBox.style.color = &quot;green&quot;;
    setTimeout(() =&gt; msgBox.remove(), 3000);

    document.body.removeChild(fileInput);
};

fileInput.click();


}

function renderArchivos() {
fileList.innerHTML = archivos
.map((f, i) => &lt;div class=&quot;file-item&quot;&gt; &lt;span&gt;ðŸ“Ž ${f.name}&lt;/span&gt; &lt;button  type=&quot;button&quot;  onclick=&quot;eliminarArchivo(${i})&quot;  style=&quot;border:none; background:none; color:red; cursor:pointer; font-weight:bold; padding:0 5px;&quot; &gt; âœ– &lt;/button&gt; &lt;/div&gt;)
.join("");
}

function eliminarArchivo(i) {
archivos.splice(i, 1);
renderArchivos();
}

// ------------------------
// LÃ“GICA DE ENVÃO (ADAPTADA AL NUEVO DISEÃ‘O)
// ------------------------
document.getElementById("firmarBtn").addEventListener("click", async () => {
try {
if (archivos.length === 0) {
document.getElementById("mensaje").textContent = "âš ï¸ No hay archivos adjuntos (opcional)";
}

    document.getElementById(&quot;mensaje&quot;).textContent = &quot;â³ Enviando datos...&quot;;
    document.getElementById(&quot;firmarBtn&quot;).disabled = true;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#BDBDBD&quot;; 

    // 1. CAPTURAR DATOS DE LA TABLA HARDCODEADA
    const personasLimpieza = document.getElementById(&quot;personasLimpieza&quot;).value;

    const residuosDataCollected = RESIDUO_FIELDS.map(r =&gt; {
        const prodValue = document.getElementById(r.prod).value;
        const contValue = document.getElementById(r.cont).value;

        return {
            tipo: r.type,
            // parseFloat para permitir decimales en producciÃ³n
            produccion: prodValue !== &#39;&#39; ? parseFloat(prodValue) : null,
            // parseInt para asegurar que contenedores es entero
            contenedores: contValue !== &#39;&#39; ? parseInt(contValue, 10) : null,
            periodicidad: document.getElementById(r.period).value,
            destino: document.getElementById(r.dest).value,
        };
    });


    // 2. PREPARAR FORM DATA
    const formData = new FormData();
    formData.append(&quot;entry.960913048&quot;, municipioNombre); // Municipio Nombre
    
    // **NOTA: REEMPLAZAR entry.RESIDUOS_FIELD_ID_AQUI con la ID de la tabla de residuos
    formData.append(&quot;entry.RESIDUOS_FIELD_ID_AQUI&quot;, JSON.stringify(residuosDataCollected));
    
    // **NOTA: REEMPLAZAR entry.LIMPIEZA_FIELD_ID_AQUI con la ID del campo de Limpieza Viaria
    formData.append(&quot;entry.LIMPIEZA_FIELD_ID_AQUI&quot;, personasLimpieza); 

    // **NOTA: REEMPLAZAR entry.ARCHIVOS_RESIDUOS_FIELD_ID_AQUI con la ID de la lista de archivos
    formData.append(&quot;entry.ARCHIVOS_RESIDUOS_FIELD_ID_AQUI&quot;, archivos.map(a=&gt;a.name).join(&quot;\n&quot;));

    // 3. ENVIAR
    await fetch(URL_GOOGLE_FORMS, { method:&quot;POST&quot;, body: formData, mode:&quot;no-cors&quot; });

    document.getElementById(&quot;mensaje&quot;).textContent = &quot;âœ… Datos enviados correctamente&quot;;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#303F9F&quot;;
    
    // Limpiar
    archivos = [];
    renderArchivos();
    document.getElementById(&quot;personasLimpieza&quot;).value = &#39;&#39;;
    
    // Limpiar campos de la tabla
    RESIDUO_FIELDS.forEach(r =&gt; {
        document.getElementById(r.prod).value = &#39;&#39;;
        document.getElementById(r.cont).value = &#39;&#39;;
        document.getElementById(r.dest).value = &#39;&#39;;
        // Resetear el select a la primera opciÃ³n si es necesario
        document.getElementById(r.period).selectedIndex = 0; 
    });
    
} catch(error) {
    document.getElementById(&quot;mensaje&quot;).textContent = &quot;âŒ Error: &quot; + error.message;
    document.getElementById(&quot;firmarBtn&quot;).disabled = false;
    document.getElementById(&quot;firmarBtn&quot;).style.backgroundColor = &quot;#3F51B5&quot;;
}


});

// --- Control de acceso ---
municipioLogin = localStorage.getItem("usuarioActual");

if (!municipioLogin) {
Â  window.location.href = "login.html";
}

document.addEventListener("DOMContentLoaded", () => {
Â  const muniName = document.getElementById("muniName");
Â  if (muniName) {Â 
Â  Â  muniName.textContent = localStorage.getItem("usuarioNombre") || municipioLogin;Â  }

Â  const formMunicipio = "122";
Â  if (municipioLogin !== formMunicipio) {
Â  Â  // Usamos console.error en lugar de alert()
console.error("No tienes permiso para este municipio. Redirigiendo a login.");
Â  Â  window.location.href = "login.html";
Â  }
});

</script>

</body>
</html>