<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EIEL {{ fase_actual }} - Acceso</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    /* --- VARIABLES & BASE --- */
    :root {
        --primary: #2563eb;       /* blue-600 */
        --primary-dark: #1e40af;  /* blue-800 */
        --bg-body: #f1f5f9;       /* slate-100 */
        
        /* Bordes temáticos */
        --theme-agua: #3b82f6;
        --theme-obras: #eab308;
        --theme-residuos: #22c55e;
        --theme-cementerios: #64748b;
    }

    body { 
        background-color: var(--bg-body); 
        font-family: 'Inter', sans-serif; 
        display: flex; align-items: center; justify-content: center; 
        min-height: 100vh; margin: 0; padding: 1rem;
    }

    /* --- PANEL PRINCIPAL --- */
    .panel { 
        background: white; 
        border-radius: 16px; 
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); 
        max-width: 550px; width: 100%; 
        overflow: hidden; 
        display: flex; flex-direction: column;
    }

    /* --- CABECERA NUEVA (FLEX) --- */
    .panel-header { 
        background-color: var(--primary); 
        padding: 1.2rem 1.5rem; /* Más compacto */
        color: white; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        min-height: 80px;
    }
    
    .header-branding h1 { margin: 0; font-size: 1.5rem; font-weight: 800; line-height: 1; }
    .header-branding p { margin: 0; font-size: 0.85rem; opacity: 0.9; margin-top: 2px; }

    /* Info Municipio (Lado derecho cabecera) */
    .header-user-info { text-align: right; display: none; /* Oculto por defecto */ }
    .header-user-info.active { display: block; }
    
    .muni-name { display: block; font-weight: 600; font-size: 1rem; line-height: 1.2; }
    .muni-badge { 
        display: inline-block; 
        background: rgba(255,255,255,0.2); 
        font-size: 0.75rem; padding: 2px 8px; 
        border-radius: 99px; margin-top: 4px; 
    }

    /* --- FORMULARIOS --- */
    .form-section { padding: 2rem; }
    .input-group { margin-bottom: 1.2rem; }
    label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem; color: #475569; }
    
    .input-field { 
        width: 100%; padding: 0.8rem; 
        border: 1px solid #cbd5e1; border-radius: 8px; 
        font-size: 1rem; background: white; 
    }
    .input-field:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary); }

    .btn-entrar {
        width: 100%; padding: 0.9rem; margin-top: 1rem;
        background-color: var(--primary); color: white; 
        font-weight: 700; border-radius: 8px; border: none; cursor: pointer; font-size: 1rem;
        transition: background 0.2s;
    }
    .btn-entrar:hover { background-color: var(--primary-dark); }

    /* --- MENÚ GRID (NUEVO) --- */
    .grid-menu { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 1rem; 
        margin-top: 0.5rem;
    }

    .card-btn { 
        display: flex; flex-direction: column; 
        align-items: center; justify-content: center; text-align: center;
        padding: 1.5rem 1rem; 
        border: 1px solid #e2e8f0; border-radius: 12px;
        text-decoration: none; color: #334155; 
        background: white; 
        transition: all 0.2s ease;
        border-bottom: 4px solid transparent; /* Borde de color abajo */
    }
    
    .card-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); background-color: #f8fafc; }
    
    .card-btn .icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
    .card-btn .label { font-weight: 600; font-size: 0.95rem; }

    /* Colores específicos para los bordes inferiores */
    .c-agua { border-bottom-color: var(--theme-agua); }
    .c-obras { border-bottom-color: var(--theme-obras); }
    .c-residuos { border-bottom-color: var(--theme-residuos); }
    .c-cementerios { border-bottom-color: var(--theme-cementerios); }

    /* Utilidades */
    .hidden { display: none !important; }
    .error-msg { color: #ef4444; text-align: center; margin-top: 1rem; font-size: 0.9rem; display: none; }
    .footer-link { 
        text-align: center; margin-top: 2rem; display: block; 
        color: #94a3b8; font-size: 0.9rem; text-decoration: underline; cursor: pointer; 
    }
</style>
</head>
<body>

<div class="panel">
    <div class="panel-header">
        <div class="header-branding">
            <h1>EIEL {{ fase_actual }}</h1>
            <p>Portal de Recogida</p>
        </div>
        
        <div id="headerUserInfo" class="header-user-info">
            <span id="displayMuniName" class="muni-name">Municipio</span>
            <span id="displayMuniCode" class="muni-badge">000</span>
        </div>
    </div>

    <div id="viewLogin" class="form-section">
        <div class="input-group">
            <label>Seleccione Municipio</label>
            <select id="muniSelect" class="input-field">
                <option value="">-- Buscar en la lista --</option>
            </select>
        </div>

        <div class="input-group">
            <label>Código de Acceso</label>
            <input type="password" id="muniCode" class="input-field" placeholder="••••••••">
        </div>

        <button id="btnLogin" class="btn-entrar">Acceder al Portal</button>
        <p id="errorMsg" class="error-msg">Código incorrecto o municipio no válido</p>
    </div>

    <div id="viewMenu" class="form-section hidden">
        <div class="grid-menu">
            <a id="lnkAgua" href="#" class="card-btn c-agua">
                <span class="icon">💧</span>
                <span class="label">Agua</span>
            </a>
            <a id="lnkObras" href="#" class="card-btn c-obras">
                <span class="icon">🏗️</span>
                <span class="label">Obras</span>
            </a>
            <a id="lnkResiduos" href="#" class="card-btn c-residuos">
                <span class="icon">♻️</span>
                <span class="label">Residuos</span>
            </a>
            <a id="lnkCementerios" href="#" class="card-btn c-cementerios">
                <span class="icon">⚰️</span>
                <span class="label">Cementerios</span>
            </a>
        </div>

        <a onclick="logout()" class="footer-link">Cerrar Sesión</a>
    </div>
</div>

<script>
    // DATOS DE PYTHON
    const MUNICIPIOS = {{ municipios_lista | safe }}; 
    const AUTH_HASHES = {{ auth_hashes | safe }}; 

    // Referencias UI
    const ui = {
        login: document.getElementById('viewLogin'),
        menu: document.getElementById('viewMenu'),
        select: document.getElementById('muniSelect'),
        input: document.getElementById('muniCode'),
        btn: document.getElementById('btnLogin'),
        error: document.getElementById('errorMsg'),
        name: document.getElementById('muniNameDisplay'),
        code: document.getElementById('muniCodeDisplay'),
        links: {
            agua: document.getElementById('lnkAgua'),
            obras: document.getElementById('lnkObras'),
            residuos: document.getElementById('lnkResiduos'),
            cementerios: document.getElementById('lnkCementerios')
        }
    };

    // 1. Llenar Select
    MUNICIPIOS.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.code;
        opt.textContent = `${m.name} (${m.code})`;
        ui.select.appendChild(opt);
    });

    // 2. Función Hash SHA-256 (Nativa navegador)
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // 3. Login
    ui.btn.addEventListener('click', async () => {
        const selectedCode = ui.select.value;
        const enteredPass = ui.input.value.trim();

        if(!selectedCode || !enteredPass) {
            showError("Seleccione un municipio e introduzca el código.");
            return;
        }

        // Validar
        const trueHash = AUTH_HASHES[selectedCode]; // Hash real del municipio
        const inputHash = await sha256(enteredPass); // Hash de lo que ha escrito el usuario

        if (trueHash === inputHash) {
            // ÉXITO
            const muniName = ui.select.options[ui.select.selectedIndex].text.split('(')[0].trim();
            loginSuccess(selectedCode, muniName);
        } else {
            // ERROR
            showError("Código de acceso incorrecto.");
        }
    });

    // 4. Gestión Sesión
    function loginSuccess(code, name) {
        localStorage.setItem("eiel_session_code", code);
        localStorage.setItem("eiel_session_name", name);
        
        ui.name.textContent = name;
        ui.code.textContent = code;
        
        ui.links.agua.href = `agua_${code}.html`;
        ui.links.obras.href = `obras_${code}.html`;
        ui.links.residuos.href = `residuos_${code}.html`;
        ui.links.cementerios.href = `cementerios_${code}.html`;

        ui.login.classList.add('hidden');
        ui.menu.classList.remove('hidden');
        ui.error.style.display = 'none';
    }

    function checkSession() {
        const code = localStorage.getItem("eiel_session_code");
        const name = localStorage.getItem("eiel_session_name");
        if(code && name) {
            loginSuccess(code, name);
        }
    }

    window.logout = function() {
        localStorage.removeItem("eiel_session_code");
        window.location.reload();
    }

    function showError(msg) {
        ui.error.textContent = msg;
        ui.error.style.display = 'block';
    }

    // Init
    checkSession();

</script>
</body>
</html>