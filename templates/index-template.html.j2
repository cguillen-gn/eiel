<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // 1. VARIABLES PYTHON
    const FIREBASE_CONFIG = {{ firebase_config_data | safe }}; 
    const MUNICIPIOS_DATA = {{ municipios_json_data | safe }}; 
    const AUTH_MAP = {{ mapeo_email_codigo_data | safe }}; // Ahora contiene Base64
    
    // 2. INIT
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    
    // 3. REFERENCIAS UI
    const refs = {
        muniName: document.getElementById("muniNamePlaceholder"),
        userEmail: document.getElementById("userEmailPlaceholder"),
        errorMsg: document.getElementById("errorMsg"),
        loader: document.getElementById("loader"),
        loadingSection: document.getElementById("loadingSection"),
        protectedContent: document.getElementById('contenido-protegido'),
        statusMessage: document.getElementById("statusMessage"),
        links: {
            agua: document.getElementById("linkAgua"),
            obras: document.getElementById("linkObras"),
            residuos: document.getElementById("linkResiduos"),
            cementerios: document.getElementById("linkCementerios")
        }
    };

    const redirectToLogin = (message) => {
        refs.statusMessage.textContent = "Acceso Denegado";
        refs.errorMsg.textContent = message;
        refs.errorMsg.classList.remove("hidden");
        refs.loader.classList.add("hidden"); 
        // Esperamos 2s y mandamos al login
        setTimeout(() => { window.location.href = "login.html"; }, 2000);
    };

    // 4. LÓGICA DE AUTORIZACIÓN (SOLUCIÓN BASE64)
    const handleAuthUser = (user) => {
        if (!user) {
            redirectToLogin("Sesión no iniciada.");
            return;
        }

        console.log("🔍 Verificando usuario:", user.email);

        // A. Normalizar email (igual que en Python)
        const cleanEmail = user.email.trim().toLowerCase();
        
        // B. Convertir a Base64 (btoa es nativo del navegador)
        const userB64 = btoa(cleanEmail);
        
        console.log("🔑 Código generado:", userB64);

        // C. Buscar en la lista
        const muniCodeRaw = AUTH_MAP[userB64];
        
        if (!muniCodeRaw) {
            console.warn("⛔ No encontrado en la lista de permisos.");
            redirectToLogin("Usuario no autorizado.");
            return;
        }

        console.log("✅ Autorizado para municipio:", muniCodeRaw);

        // D. Éxito: Configurar UI
        const normalizedMuniCode = String(muniCodeRaw).padStart(3, '0');
        const muniObj = MUNICIPIOS_DATA.find(m => String(m.code).padStart(3,'0') === normalizedMuniCode);
        const actualMuniName = muniObj ? muniObj.name : `Municipio ${normalizedMuniCode}`;
        
        localStorage.setItem("userEmailActual", user.email); 
        localStorage.setItem("municipioCodigoActual", normalizedMuniCode);
        
        refs.userEmail.textContent = user.email;
        refs.muniName.textContent = actualMuniName;
        refs.statusMessage.textContent = "Seleccione un formulario:";

        // Actualizar enlaces
        refs.links.agua.href = `agua_${normalizedMuniCode}.html`;
        refs.links.obras.href = `obras_${normalizedMuniCode}.html`;
        refs.links.residuos.href = `residuos_${normalizedMuniCode}.html`;
        refs.links.cementerios.href = `cementerios_${normalizedMuniCode}.html`;

        refs.loadingSection.classList.add("hidden");
        refs.protectedContent.classList.remove("hidden");
    };

    onAuthStateChanged(auth, handleAuthUser);
    
    document.getElementById("btnLogout").addEventListener('click', () => {
        signOut(auth).then(() => { window.location.href = 'login.html'; });
    });
</script>