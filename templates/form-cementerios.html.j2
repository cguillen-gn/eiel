{% extends "base.html.j2" %}

{% block title %}Cementerios{% endblock %}
{% block header_icon %}‚ö∞Ô∏è{% endblock %}
{% block header_title %}Cementerios Municipales{% endblock %}

{% block content %}

{# 1. Estado Vac√≠o (Si no hay cementerios) #}
{% if cementerios|length == 0 %}
<div class="card" style="text-align: center; padding: 3rem;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö∞Ô∏è</div>
    <h3 style="color: var(--text-secondary);">No hay cementerios registrados</h3>
    <p style="color: var(--text-secondary);">Su municipio no tiene cementerios en la base de datos.</p>
</div>
{% else %}

{# 2. Tarjeta de Informaci√≥n #}
<div class="card" style="background-color: #fffbeb; border-left: 4px solid var(--warning);">
    <p style="font-size: 0.9rem; color: #92400e;">
        <strong>OCUPACI√ìN:</strong> Para la correcta valoraci√≥n del nivel de saturaci√≥n, indique el n√∫mero de unidades ocupadas.<br>
        El total se calcula sumando: Ocupadas + Concesi√≥n + Propiedad + Libres.
    </p>
</div>

{# 3. Bucle de Cementerios #}
{% for cem in cementerios %}
<div class="card">
    <h2 class="section-title">üìç {{ cem.nombre }}</h2>
    
    <div class="cementerio-table-wrapper">
        <table class="cementerio-table">
            <thead>
                <tr>
                    <th class="header-ocupacion" colspan="2">OCUPACI√ìN</th>
                    <th>FOSAS</th>
                    <th>NICHOS</th>
                    <th>COLUMBARIOS</th>
                    <th>OSARIOS</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label-cell">OCUPADAS</td>
                    <td class="sublabel-cell"></td> 
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="ocupadas_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="ocupadas_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="ocupadas_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="ocupadas_osarios" placeholder="0"></td>
                </tr>

                <tr>
                    <td class="label-cell" rowspan="3">LIBRES</td> 
                    <td class="sublabel-cell">EN CONCESI√ìN</td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_concesion_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_concesion_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_concesion_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_concesion_osarios" placeholder="0"></td>
                </tr>

                <tr>
                    <td class="sublabel-cell">PROPIEDAD PRIVADA</td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_propiedad_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_propiedad_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_propiedad_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_propiedad_osarios" placeholder="0"></td>
                </tr>

                <tr>
                    <td class="sublabel-cell">
                        PROPIEDAD MUNICIPAL<br>
                        <span style="font-size: 0.75rem;">(DISPONIBLES)</span>
                    </td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_municipal_fosas" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_municipal_nichos" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_municipal_columbarios" placeholder="0"></td>
                    <td><input type="number" min="0" data-cem="{{ loop.index }}" data-tipo="libres_municipal_osarios" placeholder="0"></td>
                </tr>

                <tr class="total-row">
                    <td class="label-cell" colspan="2">TOTAL</td> 
                    <td id="total_fosas_{{ loop.index }}">0</td>
                    <td id="total_nichos_{{ loop.index }}">0</td>
                    <td id="total_columbarios_{{ loop.index }}">0</td>
                    <td id="total_osarios_{{ loop.index }}">0</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endfor %}

{# 4. Adjuntos #}
<div class="card">
    <h2 class="section-title">Documentaci√≥n Adjunta (Opcional)</h2>
    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" style="border: 2px dashed var(--border); padding: 2rem; text-align: center; cursor: pointer; border-radius: 8px;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìé</div>
        <div style="color: var(--primary); font-weight: 600;">Haga clic para adjuntar archivos</div>
        <input type="file" id="fileInput" multiple style="display: none;">
    </div>
    <div id="fileList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;"></div>
</div>

{# 5. Bot√≥n Firmar #}
<div class="card">
    <button id="firmarBtn" class="btn btn-primary">
        <span>‚úì</span> Firmar y enviar formulario
    </button>
    <div id="mensaje" class="message"></div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Inyectamos datos del servidor
    const cementerios = {{ cementerios_json | safe }};
    
    // ==========================================
    // 1. L√ìGICA DE C√ÅLCULO (Igual que antes)
    // ==========================================
    function calcularTotales() {
        cementerios.forEach((cem, index) => {
            const cemIndex = index + 1;
            const inputs = document.querySelectorAll(`input[data-cem="${cemIndex}"]`);
            
            let totales = { fosas: 0, nichos: 0, columbarios: 0, osarios: 0 };
            
            inputs.forEach(input => {
                const tipo = input.dataset.tipo;
                const valor = parseInt(input.value) || 0;
                
                if (tipo.includes('fosas')) totales.fosas += valor;
                if (tipo.includes('nichos')) totales.nichos += valor;
                if (tipo.includes('columbarios')) totales.columbarios += valor;
                if (tipo.includes('osarios')) totales.osarios += valor;
            });
            
            // Actualizar DOM de forma segura
            const setTotal = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.textContent = val;
            };

            setTotal(`total_fosas_${cemIndex}`, totales.fosas);
            setTotal(`total_nichos_${cemIndex}`, totales.nichos);
            setTotal(`total_columbarios_${cemIndex}`, totales.columbarios);
            setTotal(`total_osarios_${cemIndex}`, totales.osarios);
        });
    }

    document.addEventListener('input', (e) => {
        if (e.target.type === 'number' && e.target.dataset.cem) {
            calcularTotales();
        }
    });

    // ==========================================
    // 2. GESTI√ìN DE ARCHIVOS (UI Local)
    // ==========================================
    let archivos = [];
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");

    if (fileInput) {
        fileInput.onchange = () => {
            archivos.push(...Array.from(fileInput.files));
            renderArchivos();
            fileInput.value = '';
        };
    }

    window.eliminarArchivo = (i) => {
        archivos.splice(i, 1);
        renderArchivos();
    }

    function renderArchivos() {
        if (archivos.length === 0) {
            fileList.innerHTML = '';
            return;
        }
        fileList.innerHTML = archivos.map((f, i) => `
            <div style="display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid var(--border);">
                <span>üìÑ ${f.name}</span>
                <button type="button" onclick="eliminarArchivo(${i})" class="btn-danger">‚úñ</button>
            </div>
        `).join("");
    }

    // ==========================================
    // 3. ENV√çO (Usa UploadService y window.EIEL_CONFIG)
    // ==========================================
    const btnFirmar = document.getElementById("firmarBtn");
    const mensajeDiv = document.getElementById("mensaje");

    function mostrarMensaje(texto, tipo) {
        mensajeDiv.textContent = texto;
        mensajeDiv.className = `message ${tipo}`;
        mensajeDiv.style.display = 'block';
    }

    if (btnFirmar) {
        btnFirmar.addEventListener("click", async () => {
            btnFirmar.disabled = true;
            mostrarMensaje("‚è≥ Subiendo archivos...", "info");

            // A) Subir Archivos a Drive
            let erroresSubida = 0;
            for (const file of archivos) {
                // LLAMADA AL NUEVO SERVICIO CENTRALIZADO
                const ok = await UploadService.uploadFile(
                    file, 
                    'cementerios', 
                    window.EIEL_CONFIG.muniCode
                );
                if (!ok) erroresSubida++;
            }

            if (erroresSubida > 0) {
                mostrarMensaje(`‚ö†Ô∏è Se subieron archivos con ${erroresSubida} errores. Continuando...`, "warning");
            }

            // B) Recopilar Datos
            mostrarMensaje("‚è≥ Generando justificante...", "info");
            
            const datosCementerios = cementerios.map((cem, index) => {
                const cemIndex = index + 1;
                const inputs = document.querySelectorAll(`input[data-cem="${cemIndex}"]`);
                let datos = { nombre: cem.nombre };
                
                inputs.forEach(input => {
                    const tipo = input.dataset.tipo;
                    const val = parseInt(input.value);
                    datos[tipo] = isNaN(val) ? 0 : val;
                });
                return datos;
            });

            const userEmail = localStorage.getItem("userEmailActual");
            const payload = {
                tipo_formulario: "cementerios",
                cementerios_data: JSON.stringify(datosCementerios),
                email_usuario: userEmail,
                municipio_codigo: window.EIEL_CONFIG.muniCode,
                municipio_nombre: window.EIEL_CONFIG.muniName,
                timestamp_envio: new Date().toISOString(),
                archivos_adjuntos: archivos.map(a => a.name).join("\n")
            };

            // C) Enviar a Generar PDF
            try {
                const response = await fetch(window.EIEL_CONFIG.urlGenerarPdf, {
                    method: "POST",
                    body: new URLSearchParams(payload)
                });

                let result = {};
                try {
                    result = await response.json();
                } catch(e) {
                    // Si el servidor devuelve 200 pero el navegador bloquea el JSON por CORS
                    if(response.ok) {
                        result = { success: true, message: "Env√≠o correcto (CORS opaco)." };
                    } else {
                        throw new Error("Error de respuesta del servidor.");
                    }
                }

                if (result.success || response.ok) {
                    mostrarMensaje("‚úÖ Formulario enviado correctamente. Revisa tu email.", "success");
                    archivos = [];
                    renderArchivos();
                    if(result.downloadUrl) window.open(result.downloadUrl, '_blank');
                } else {
                    throw new Error(result.message || "Error desconocido");
                }
            } catch (error) {
                console.error(error);
                mostrarMensaje(`‚ùå Error: ${error.message}`, "error");
                btnFirmar.disabled = false;
            }
        });
    }
</script>
{% endblock %}