{% extends "base.html.j2" %}

{% block title %}Cementerios{% endblock %}
{% block header_icon %}‚ö∞Ô∏è{% endblock %}
{% block header_title %}Cementerios{% endblock %}

{% block content %}

{# 1. Estado Vac√≠o #}
{% if cementerios|length == 0 %}
<div class="card" style="text-align: center; padding: 3rem;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö∞Ô∏è</div>
    <h3 style="color: var(--text-secondary);">No hay cementerios registrados</h3>
    <p style="color: var(--text-secondary);">Su municipio no tiene cementerios en la base de datos.</p>
</div>
{% else %}

{# 2. Tarjeta de Informaci√≥n #}
<div class="card">
    <div class="info-text" style="background-color: #f8fafc; color: #475569; padding: 1.2rem; border-radius: 8px; margin-bottom: 0; border-left: 4px solid var(--theme-cementerios); font-size: 0.95rem; line-height: 1.5;">
        <h4 style="margin: 0 0 0.5rem 0; font-weight: 700; display: flex; align-items: center; gap: 8px;">
            ‚ÑπÔ∏è Instrucciones
        </h4>
        <p style="margin: 0 0 0.5rem 0;">
            A continuaci√≥n se listan los cementerios registrados. Por favor, confirme que los datos de ubicaci√≥n y titularidad siguen siendo correctos o indique cualquier modificaci√≥n en observaciones.
        </p>
    </div>
</div>

<div class="card" style="border-left: 4px solid var(--theme-cementerios);">
    <h2 class="section-title" style="color: var(--theme-cementerios);">Listado de Cementerios</h2>
    
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Nombre del Cementerio</th>
                    <th style="text-align: center;">Confirmaci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for c in cementerios %}
                <tr>
                    <td style="font-weight: 600; color: #334155;">{{ c.nombre }}</td>
                    <td style="text-align: center;">
                        <span style="background-color: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #bbf7d0;">
                            Activo
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card" style="border-left: 4px solid var(--theme-cementerios);">
    <h2 class="section-title" style="color: var(--theme-cementerios);">üìù Observaciones y Ampliaciones</h2>
    <div class="form-group">
        <label for="observaciones" class="form-label">Indique aqu√≠ si hay obras de ampliaci√≥n en curso o necesidad de ellas:</label>
        <textarea id="observaciones" class="form-input" rows="4" placeholder="Ej: Se est√° planificando una ampliaci√≥n de 50 nichos..."></textarea>
    </div>
</div>

<div class="card" style="border-left: 4px solid var(--theme-cementerios);">
    <h2 class="section-title" style="color: var(--theme-cementerios);">Documentaci√≥n Adjunta</h2>
    <div style="background-color: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 2rem; text-align: center;">
        <p style="color: #64748b; margin-bottom: 1rem;">Puede adjuntar planos, proyectos de ampliaci√≥n o informes.</p>
        
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
            üìé Seleccionar Archivos
        </button>
        <input type="file" id="fileInput" multiple style="display: none;">
        
        <div id="listaArchivos" style="margin-top: 1.5rem; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;"></div>
    </div>
</div>

<div class="card" style="border-left: 4px solid var(--theme-cementerios);">
    <h2 class="section-title" style="color: var(--theme-cementerios);">Datos de Contacto</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
            <label class="form-label">Nombre y Apellidos del T√©cnico *</label>
            <input type="text" id="tecnicoNombre" class="form-input" placeholder="Ej: Antonio L√≥pez" required>
        </div>
        <div class="form-group">
            <label class="form-label">Email de contacto *</label>
            <input type="email" id="tecnicoEmail" class="form-input" placeholder="ejemplo@ayuntamiento.es" required>
        </div>
    </div>
</div>

<div class="card" style="border-left: 4px solid var(--theme-cementerios);">
    <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
        <label style="display: flex; gap: 10px; cursor: pointer; align-items: flex-start;">
            <input type="checkbox" id="checkConformidad" style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer;">
            <span style="font-size: 0.95rem; color: #334155; line-height: 1.4;">
                <strong>Declaraci√≥n de veracidad:</strong> Como t√©cnico responsable, 
                confirmo que los datos introducidos son correctos y actualizados.
            </span>
        </label>
    </div>

    <button id="btnEnviar" class="btn btn-primary btn-cementerios" disabled style="opacity: 0.6; cursor: not-allowed;">
        üöÄ Registrar y Enviar Datos
    </button>
    
    <div id="mensaje" class="message"></div>
</div>

{% endif %}

{% endblock %}

{% block scripts %}
<script>
    document.querySelector('.site-header').classList.add('header-cementerios');

    window.EIEL_CONFIG = {
        muniCode: "{{ muni_code }}",
        muniName: "{{ muni_display }}",
        urlGenerarPdf: "{{ url_generar_pdf }}",
        urlAdjuntos: "{{ url_adjuntos }}"
    };

    // DATOS INYECTADOS
    const CEMENTERIOS = {{ cementerios_json | safe }};

    // 1. SERVICIO SUBIDA
    const UploadService = {
        toBase64: file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        }),

        async uploadFile(file, tipoFicha, muniCode) {
            try {
                const base64 = await this.toBase64(file);
                const userEmail = document.getElementById("tecnicoEmail")?.value || "anonimo";
                
                const payload = {
                    filename: file.name,
                    mimeType: file.type,
                    bytesBase64: base64,
                    municipio: muniCode,
                    usuario: userEmail,
                    tipo: tipoFicha
                };
                
                await fetch(window.EIEL_CONFIG.urlAdjuntos, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                return true;
            } catch (e) {
                console.error("Error subiendo:", e);
                return false;
            }
        }
    };

    // 2. GESTI√ìN DE COLA
    let colaAdjuntos = [];
    const fileInput = document.getElementById("fileInput");
    const listaDiv = document.getElementById("listaArchivos");

    if(fileInput) {
        fileInput.addEventListener('change', () => {
            if(fileInput.files.length > 0) {
                colaAdjuntos.push(...Array.from(fileInput.files));
                renderCola();
                fileInput.value = "";
            }
        });
    }

    function renderCola() {
        if (!listaDiv) return;
        if (colaAdjuntos.length === 0) {
            listaDiv.innerHTML = "";
            return;
        }
        listaDiv.innerHTML = colaAdjuntos.map((f, i) => `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        background: white; padding: 8px 12px; border-radius: 6px; 
                        margin-bottom: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                <span style="font-size: 0.9rem; color: #334155;">üìÑ ${f.name}</span>
                <button onclick="eliminarDeCola(${i})" style="color: #ef4444; font-weight: bold; background: none; border: none; cursor: pointer;">‚úñ</button>
            </div>
        `).join("");
    }

    window.eliminarDeCola = (index) => {
        colaAdjuntos.splice(index, 1);
        renderCola();
    }

    // 3. ENV√çO
    const btnEnviar = document.getElementById("btnEnviar");
    const checkConformidad = document.getElementById("checkConformidad");
    const mensajeDiv = document.getElementById("mensaje");

    function mostrarMensaje(texto, tipo) {
        if(!mensajeDiv) return;
        mensajeDiv.textContent = texto;
        mensajeDiv.className = `message ${tipo}`;
        mensajeDiv.style.display = 'block';
    }

    if(checkConformidad) {
        checkConformidad.addEventListener('change', function() {
            if (this.checked) {
                btnEnviar.disabled = false;
                btnEnviar.style.opacity = "1";
                btnEnviar.style.cursor = "pointer";
            } else {
                btnEnviar.disabled = true;
                btnEnviar.style.opacity = "0.6";
                btnEnviar.style.cursor = "not-allowed";
            }
        });
    }

    if(btnEnviar) {
        btnEnviar.addEventListener("click", async () => {
            const nombreTecnico = document.getElementById("tecnicoNombre").value.trim();
            const emailContacto = document.getElementById("tecnicoEmail").value.trim();

            if (!nombreTecnico || !emailContacto || !emailContacto.includes('@')) {
                mostrarMensaje("‚ö†Ô∏è Indique nombre y email de contacto v√°lidos.", "warning");
                return;
            }

            // Bloqueo
            btnEnviar.disabled = true;
            btnEnviar.style.cursor = "wait";
            mostrarMensaje("‚è≥ Procesando...", "info");

            // A. Subida diferida
            const totalArchivos = colaAdjuntos.length;
            if (totalArchivos > 0) {
                for (let i = 0; i < totalArchivos; i++) {
                    const file = colaAdjuntos[i];
                    mostrarMensaje(`‚è≥ Subiendo archivo ${i + 1} de ${totalArchivos}... (${file.name})`, "info");
                    
                    await UploadService.uploadFile(file, "cementerios", window.EIEL_CONFIG.muniCode);
                }
            }

            // B. Datos
            // En cementerios solo confirmamos que existen, as√≠ que enviamos la lista tal cual
            const datosCementerios = CEMENTERIOS;

            const payload = {
                tipo_formulario: "cementerios",
                cementerios_data: JSON.stringify(datosCementerios),
                observaciones: document.getElementById("observaciones").value || "",
                email_usuario: emailContacto,
                nombre_tecnico: nombreTecnico,
                municipio_codigo: window.EIEL_CONFIG.muniCode,
                municipio_nombre: window.EIEL_CONFIG.muniName,
                timestamp_envio: new Date().toISOString(),
                archivos_adjuntos: colaAdjuntos.map(a => a.name).join("\n")
            };

            // C. PDF
            try {
                mostrarMensaje("‚è≥ Generando informe PDF...", "info");
                
                await fetch(window.EIEL_CONFIG.urlGenerarPdf, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                mostrarMensaje("‚úÖ Formulario enviado correctamente. Revisa tu email.", "success");
                
                colaAdjuntos = [];
                renderCola();
                if(checkConformidad) {
                    checkConformidad.checked = false;
                    btnEnviar.style.opacity = "0.6";
                    btnEnviar.disabled = true;
                }

            } catch (error) {
                console.error(error);
                mostrarMensaje(`‚ùå Error t√©cnico: ${error.message}`, "error");
                btnEnviar.disabled = false;
                btnEnviar.style.cursor = "pointer";
            }
            
            document.addEventListener("DOMContentLoaded", function() {
        const faseDeEsteFormulario = "{{ fase_actual }}"; // Aqu√≠ gen_forms inyecta el dato
        const elementoHeader = document.getElementById("fase-header");
        
        if (elementoHeader) {
            elementoHeader.innerText = "Fase " + faseDeEsteFormulario;
        }
            
        });
    }
</script>
{% endblock %}